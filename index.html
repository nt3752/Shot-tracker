<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Shot Tracker v40.18</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;700;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* ===============================================
           SHOT TRACKER v39 - PRODUCTION STYLESHEET
           Mobile-first, defensive, robust
           =============================================== */
        
        :root {
            /* Core palette - golf course inspired */
            --green-900: #0d3b2f;
            --green-800: #14543f;
            --green-700: #1a6d4f;
            --green-600: #21875f;
            --green-500: #27a06f;
            --green-400: #51b385;
            --green-300: #7bc69b;
            --green-200: #a5d9b1;
            --green-100: #cfecc7;
            
            /* Neutrals */
            --gray-950: #0a0f14;
            --gray-900: #141a21;
            --gray-800: #1e262f;
            --gray-700: #28333d;
            --gray-600: #4a5763;
            --gray-500: #6c7a89;
            --gray-400: #8e9daf;
            --gray-300: #b0c0d5;
            --gray-200: #d2e3fb;
            --gray-100: #e8f1ff;
            
            /* Accents */
            --gold: #f4a61b;
            --red: #e64545;
            --blue: #4a9eff;
            
            /* Functional colors */
            --bg-app: var(--gray-950);
            --bg-card: var(--gray-900);
            --bg-card-light: var(--gray-800);
            --text-primary: var(--gray-100);
            --text-secondary: var(--gray-400);
            --text-muted: var(--gray-500);
            --border: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.12);
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
            
            /* Spacing scale */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-7: 48px;
            
            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Typography */
            --font-base: 'Barlow', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Monaco', 'Courier New', monospace;
        }
        
        /* ===============================================
           BASE STYLES
           =============================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-base);
            background: var(--bg-app);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input, select {
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* ===============================================
           LAYOUT
           =============================================== */
        
        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(to bottom, 
                rgba(10, 15, 20, 0.98) 0%,
                rgba(10, 15, 20, 0.95) 70%,
                rgba(10, 15, 20, 0.85) 100%
            );
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) var(--space-4);
        }
        
        .app-main {
            flex: 1;
            padding: var(--space-4);
            padding-bottom: var(--space-7);
        }
        
        /* ===============================================
           HEADER COMPONENTS
           =============================================== */
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .brand {
            font-size: 1.125rem;
            font-weight: 900;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        .brand-version {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-left: var(--space-2);
        }
        
        .header-icon-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1.25rem;
            transition: all 0.15s ease;
        }
        
        .header-icon-btn:active {
            transform: scale(0.95);
            background: var(--bg-card-light);
        }
        
        /* Scoreboard Pills */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-2);
        }
        
        .scoreboard-pill {
            background: linear-gradient(135deg, var(--green-800) 0%, var(--green-700) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-2) var(--space-1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .pill-value {
            font-size: 1.5rem;
            font-weight: 900;
            font-family: var(--font-mono);
            line-height: 1;
            letter-spacing: -0.5px;
        }
        
        .pill-label {
            font-size: 0.55rem;
            font-weight: 700;
            color: var(--green-200);
            margin-top: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .round-info {
            margin-top: var(--space-2);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* ===============================================
           SECTIONS
           =============================================== */
        
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .section-title {
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: var(--space-3);
        }
        
        /* ===============================================
           RANGEFINDER DISPLAY
           =============================================== */
        
        .rangefinder-display {
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
        }
        
        .distance-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: var(--space-3);
        }
        
        .distance-main {
            flex: 1;
        }
        
        .distance-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-1);
        }
        
        .distance-value {
            font-size: 2.5rem;
            font-weight: 900;
            font-family: var(--font-mono);
            line-height: 1;
            letter-spacing: -1px;
        }
        
        .distance-unit {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-left: var(--space-1);
        }
        
        .accuracy-badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: 0.625rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
            white-space: nowrap;
        }
        
        .accuracy-badge.good {
            color: var(--green-300);
            border-color: var(--green-600);
            background: rgba(39, 160, 111, 0.15);
        }
        
        .accuracy-badge.warn {
            color: var(--gold);
            border-color: rgba(244, 166, 27, 0.4);
            background: rgba(244, 166, 27, 0.15);
        }
        
        .accuracy-badge.bad {
            color: var(--red);
            border-color: rgba(230, 69, 69, 0.4);
            background: rgba(230, 69, 69, 0.15);
        }
        
        /* ===============================================
           INPUTS
           =============================================== */
        
        .input-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        .input-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        /* iOS Safari zooms on focus if font-size < 16px.
           This rule ensures no input ever triggers that behaviour. */
        input, select, textarea {
            font-size: max(1rem, 16px) !important;
        }

        .input-field {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 700;
            font-family: var(--font-mono);
            text-align: center;
        }
        
        .input-field::placeholder {
            color: var(--text-muted);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--green-500);
            box-shadow: 0 0 0 3px rgba(39, 160, 111, 0.15);
        }
        
        .input-field.compact {
            max-width: 100px;
        }
        
        .input-field.compact-sm {
            max-width: 60px;
        }
        
        /* ===============================================
           BUTTONS
           =============================================== */
        
        .btn-row {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        .btn-row:last-child {
            margin-bottom: 0;
        }
        
        .btn {
            flex: 1;
            min-width: 0;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s ease;
            border: 1px solid var(--border);
            background: var(--bg-card-light);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 100%);
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:active::before {
            opacity: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--green-700) 0%, var(--green-600) 100%);
            border-color: var(--green-500);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-card-light);
            border-color: var(--border);
        }
        
        .btn-danger {
            background: rgba(230, 69, 69, 0.15);
            border-color: rgba(230, 69, 69, 0.3);
            color: var(--red);
        }
        
        /* Blue button â€” used for the Hole picker to make it visually distinct */
        .btn-blue {
            background: linear-gradient(135deg, #1d6fa8 0%, #2589cc 100%);
            border-color: #3a9fe0;
            color: white;
        }
        
        .btn.lit {
            background: linear-gradient(135deg, var(--green-600) 0%, var(--green-500) 100%);
            border-color: var(--green-400);
            box-shadow: 0 0 0 2px rgba(39, 160, 111, 0.2);
        }
        
        .btn-pending {
            background: linear-gradient(135deg, rgba(244, 166, 27, 0.25) 0%, rgba(244, 166, 27, 0.15) 100%);
            border-color: var(--gold);
            color: var(--gold);
            animation: pulsePending 1.5s ease-in-out infinite;
        }
        
        @keyframes pulsePending {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 0 0 0 rgba(244, 166, 27, 0.4);
            }
            50% { 
                opacity: 0.85;
                box-shadow: 0 0 0 4px rgba(244, 166, 27, 0.1);
            }
        }
        
        .btn.pending {
            animation: pulse 1.2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
        }
        
        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.75rem;
        }
        
        .btn-toggle {
            background: var(--bg-card-light);
        }
        
        .btn-toggle.active {
            background: linear-gradient(135deg, var(--green-700) 0%, var(--green-600) 100%);
            border-color: var(--green-500);
        }
        
        /* ===============================================
           SHOT LIST
           =============================================== */
        
        .shot-list {
            border-top: 1px solid var(--border);
            padding-top: var(--space-3);
        }
        
        .shot-list-empty {
            padding: var(--space-4) 0;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .shot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            padding: var(--space-3) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }
        
        .shot-item:last-child {
            border-bottom: none;
        }
        
        .shot-left {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
            min-width: 0;
        }
        
        .shot-number {
            font-size: 0.75rem;
            font-weight: 900;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: var(--space-1) var(--space-2);
            flex-shrink: 0;
        }
        
        .shot-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: var(--space-2);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 0;
        }
        
        .shot-select:disabled {
            opacity: 0.5;
        }
        
        .shot-distance {
            font-size: 1rem;
            font-weight: 900;
            font-family: var(--font-mono);
            color: var(--text-primary);
            white-space: nowrap;
        }
        
        .shot-input {
            width: 80px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: var(--space-2);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 700;
            font-family: var(--font-mono);
            text-align: center;
        }
        
        .shot-input:disabled {
            opacity: 0.5;
        }
        
        /* ===============================================
           MODAL / SHEET
           =============================================== */
        
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            pointer-events: none; /* Don't intercept clicks when hidden */
        }
        
        .backdrop.active {
            display: block;
            pointer-events: auto; /* Allow clicks when active */
        }
        
        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-strong);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            z-index: 201;
            padding: var(--space-4);
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none; /* Hidden by default */
        }
        
        .sheet.active {
            transform: translateY(0);
            display: block; /* Show when active */
        }
        
        .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border);
        }
        
        .sheet-title {
            font-size: 1rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sheet-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        /* ===============================================
           CADDY SUGGESTIONS
           =============================================== */
        
        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }
        
        .suggestion-info {
            flex: 1;
        }
        
        .suggestion-club {
            font-size: 1rem;
            font-weight: 900;
            margin-bottom: var(--space-1);
        }
        
        .suggestion-meta {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .suggestion-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--green-700);
            border: 1px solid var(--green-500);
            border-radius: var(--radius-md);
            color: white;
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        /* ===============================================
           HOLE PICKER
           =============================================== */
        
        .hole-picker-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
        }
        
        .hole-picker-btn {
            min-height: 100px;
            background: var(--bg-card-light);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: var(--space-3) var(--space-1);
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .hole-picker-btn:active {
            transform: scale(0.95);
            background: var(--green-700);
        }
        
        .hole-picker-num {
            font-size: 2rem;
            font-weight: 900;
            font-family: var(--font-mono);
            line-height: 1;
        }
        
        .hole-picker-par {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .hole-picker-info {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }
        
        /* ===============================================
           SCORECARD
           =============================================== */
        
        .sc-section-title {
            font-size: 0.65rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin: var(--space-3) 0 var(--space-2);
        }

        .sc-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            table-layout: fixed;  /* Fixed layout enforces column widths */
        }

        /* Column widths proportionate to max expected data:
           Hole:  2 digits           â†’ 14%
           Yds:   3 digits           â†’ 20%
           Par:   1 digit            â†’ 12%
           Score: symbol + 2 digits  â†’ 24%
           +/-:   sign + 2 digits    â†’ 30% */
        .sc-col-hole  { width: 14%; }
        .sc-col-yds   { width: 20%; }
        .sc-col-par   { width: 12%; }
        .sc-col-score { width: 24%; }
        .sc-col-rel   { width: 30%; }

        .sc-table th {
            font-size: 0.6rem;
            font-weight: 700;
            color: var(--text-muted);
            text-align: center;
            padding: var(--space-1) 2px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
        }

        .sc-table th.sc-left { text-align: left; }

        .sc-row td {
            text-align: center;
            padding: 6px 2px;
            font-size: 0.9rem;
            font-weight: 700;
            border-bottom: 1px solid var(--border);
        }

        .sc-row td.sc-left { text-align: left; }

        /* Green tint on the hole currently being played */
        .sc-row.sc-active {
            background: rgba(74,222,128,0.08);
        }
        .sc-row.sc-active td:first-child {
            color: var(--green-400);
        }

        /* Section subtotal row (Front 9 / Back 9) */
        .sc-subtotal td {
            text-align: center;
            padding: 6px 2px;
            font-size: 0.85rem;
            font-weight: 900;
            background: rgba(255,255,255,0.04);
            color: var(--text-primary);
            border-top: 1px solid var(--border-strong);
            border-bottom: 1px solid var(--border-strong);
        }
        .sc-subtotal td.sc-left { text-align: left; }

        /* Grand total row */
        .sc-total td {
            text-align: center;
            padding: 8px 2px;
            font-size: 1rem;
            font-weight: 900;
            background: rgba(74,222,128,0.1);
            color: var(--text-primary);
            border-top: 2px solid var(--green-400);
        }
        .sc-total td.sc-left { text-align: left; }

        /* Base symbol â€” fixed box so all borders render consistently */
        .sc-sym {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            font-size: 0.85rem;
            font-weight: 900;
            box-sizing: border-box;
        }

        /* Eagle or better: double thin circle, red number.
           Inner ring = border, outer ring = outline offset outward. */
        .sc-eagle {
            border: 1.5px solid var(--red);
            border-radius: 50%;
            outline: 1.5px solid var(--red);
            outline-offset: 3px;
            color: var(--red);
        }

        /* Birdie: single thin circle, red number */
        .sc-birdie {
            border: 1.5px solid var(--red);
            border-radius: 50%;
            color: var(--red);
        }

        /* Par: plain number, no border, white */
        .sc-par {
            color: var(--text-primary);
        }

        /* Bogey: single thin square, white number */
        .sc-bogey {
            border: 1.5px solid var(--text-primary);
            border-radius: 3px;
            color: var(--text-primary);
        }

        /* Double bogey: double thin square, white number.
           Inner ring = border, outer ring = outline offset outward. */
        .sc-double {
            border: 1.5px solid var(--text-primary);
            border-radius: 3px;
            outline: 1.5px solid var(--text-primary);
            outline-offset: 3px;
            color: var(--text-primary);
        }

        /* Triple bogey+: double thin square, white "+N", smaller font to fit */
        .sc-triple {
            border: 1.5px solid var(--text-primary);
            border-radius: 3px;
            outline: 1.5px solid var(--text-primary);
            outline-offset: 3px;
            color: var(--text-primary);
            font-size: 0.6rem;
        }

        /* Unplayed hole placeholder */
        .sc-none {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

                /* ===============================================
           UTILITIES
           =============================================== */
        
        .hidden {
            display: none !important;
        }
        
        .toast {
            position: fixed;
            bottom: calc(var(--space-4) + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            background: rgba(10, 15, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-strong);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            animation: toastSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* ===============================================
           RESPONSIVE
           =============================================== */
        
        @media (max-width: 380px) {
            .scoreboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pill-value {
                font-size: 1.75rem;
            }
            
            .distance-value {
                font-size: 2rem;
            }
            
            .btn {
                font-size: 0.75rem;
                padding: var(--space-2) var(--space-3);
            }
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-top">
                <div class="brand">
                    Shot Tracker
                    <span class="brand-version">v40.18</span>
                </div>
                <div style="display: flex; gap: var(--space-2);">
                    <button class="header-icon-btn" id="btnScorecard" type="button" aria-label="Scorecard">ðŸ“‹</button>
                    <button class="header-icon-btn" id="btnExport" type="button" aria-label="Report/CSV">ðŸ“Š</button>
                    <button class="header-icon-btn" id="btnNewRoundHeader" type="button" aria-label="New Round">ðŸ”„</button>
                    <button class="header-icon-btn" id="btnLibrary" type="button" aria-label="Library">ðŸ“š</button>
                    <button class="header-icon-btn" id="btnBagHeader" type="button" aria-label="Bag Editor"><img src="data:image/png;base64,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" style="width:22px;height:22px;object-fit:contain;filter:invert(1);"></button>
                    <button class="header-icon-btn" id="btnSettings" type="button" aria-label="Course Setup"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAIAAACR5s1WAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAAQcUlEQVR42j1YWYwc13U9975XVd1dvU337JzhcBFFbSRFyZKcyIts2XKkxIYRI1YSIYmRAFIQ+8sI8hMYCOyPBMhfAgQ2nBVIjMSWHduRnNiRBGqXLFIixZ3DIWc4+9b7WlXv3nzUMA00Cii8qvfqnnvPPefS6TdfOnzHgWE0ZDKAAgoyqgp1ICYCRAlQ0r0/QERIf0SqAAQAFCAQKF0tIkSqEBICKwBSiDqCEltVhRKRAwgKWygVyyOV4aAHYk5XgogIKsRGVUmFiEQTKBGbdHOoAxE0PY+oAkC6PVTS0wCqkHSNAgRAGQAZA5X0O5UASawTceJEGOQEDIAgSiCwOlVVgJSIYVUdnKTbqgJQKIk6IiEikIGokkKEiAhQlTQ6RKQQqNx+TuAEDEK63FkFAFYiw56qgvYiRwIQwAQRAoMt1ACqqqQKsgolApNPqgpVgBgMAtMeVGCFgljEAcps0/sMVSYQE2saNUtkmC2xU0q/n1WVlMAC2Nsn/H/gFVAhgKAie/sRoLcThRhIU0eJmNNUMQx1qqSqRCRsyKQoCrESGUuUwqwE3nsdWFRgAtL0hgqUiUgVzCAYIiJiZCFu6CIlEKU4AurSq4BBttfrDoYRERGRc4nnBwAN+j0VJ6IKIUh1pGCFlIgIDDKkAODSpIOACEg/kFXFGBaV/qDbG3Y1kV7S93O5qcIYAbFLmBhE2MsqJSBy0ulHvu8HQUbEFbJhfWtlZ3O1OjkXayLigiCzu7tjDVsCgywoBgAmVTAZIihYIaQKCFQ89nbqm0vrNyIX+57GyWB+4fpFrZ+449hThz49ki9FSaQqRHsIEIERkSoziyTWC66+/9rq0ry45MyrL3zqN5+11nh+ACUmYqiqujTjNE1ghQACSdEFkPEKV7cWTs2f6rcauyu3zl6+9Oa1yyZTxmrnxcuv/fO5H17enI+dM2wBEAxABFJxTAogSZxl+tn3vzt39ORHn/jy5uqiqhovUBVidurMV7/6XLVSdU5pj3kAKNhAFRADihN3c2fhH84+X2Vve7v9rbd/9qMb52w+/9EHT7a0vb20teV3312/sNXZOTJ6MGsDgQBCzM5Jfxh5QSaJ4lxYqI5Pdpu7H7z10v2Pfm764F3xYJAkcbfbCXNZBkDMSrerKmVJF5E6BjmR/7z0wjdf//YscgfzM9+/ceH+/SeePHD8i4/c7+LWJ3/14XI5DJSTwJ7ZuLTSXDOGFQoYVWJmVRUnmUxm0GvH/faZN36ezeUzYaGxvcZsmC0E6oR1j37TC4OgqgQFxDP+udUPX775jkf23vKBZ3/6r0uD5u/d+4nJsNQdDm6urD7/9lv/c/5yr9Hy3WA0HBkNq6K6RzRQAM6ptTZfLA16nSvnT49OzoW53Nat+SgagiTMhUEmo+Isp50iJVxVBqWJArBz7nxjsUnuk8XZFy+du7q9cvf+/X/11j9Vwuw9/uxPrl988/y1b3zmy6ubizuD4YhvLLGk7wIpIWX9OE7arSZ7uSef+ToRut2OiHQ7zWaz2e8Pep3WWGnSQhJoopoQbBoEAESkKmwYjWSw3p6bmTLV7Of2Hcvsy2ZUd9dr3/npLwLx/vTkE/uzwdTBYz+qn9nxd89tXPnsnR9LhhGDRImNzWVsfWeD2aiKc47UsTUAGxVVIbHTk2PlcskqHEEIChenPQlQkELVGDvBY5WO6ex23t5Y+8pjX/zxrZcK+bAbRUea1T//9ad3a835tcW5fWVvK44Hg6ub1x+ZPOn7CjakCkmqlUqpGEbDZhhW4qjvZ/Ld1mYmN2K9wCVxs3arXJl14hggEBMRs2GitJurAmwhqmOy78jkWq357+de/Zv3fzA5Xg3DDAL/K596spQtfO/m66eS5e+c/0Xo2/ZGO9qKPzhzHnscxwpi9luNrVZjq9/rLN98Lxr2Fuffabc2nVIUx43aehwnIGv3OF8BEsVtTQAYtvVB8631C3kTHBidsp7tu9hTSBzPTIz+x43X/MvKRbN2a82zCP3qY/cd+9K9T2WsT4TbvZOdGxbLk8bOiIvnjnxMRO649wmA4BKQTh04yTaAOqtpQkIIBIWSS/PCkNlsb+9GTSTImMHxXPn68vpiUKpaf/KeqYbh+cXl4Xo0Mx6aolfNFX/rgc/vK09GcV9cDEBVCKQqzMYwMfvNZqtSKYl6hoy4oc8szqk6AjMgxKSAqkCFwLcLTDwmFvRIFm+t3O+N9Gr9Dy4vdobJTrPLzGK9ezLFyXKpnsTjufJIpjSIBk6EQABSTZYGtj8c/s4zf3T4yIm/+OZfr1x/5cP3nr989oXa1qIxvqoCYtMMSJ9UCESIGUCibjycnClMznfng3Ck3atPWtv0EhnzVpa382Eua2xS5G5oRkx2Z9DcHezOFKeHyZBoj/sBBZiJIHr82DGQfeSRR5LYsaEULxAxEYgtkLYcAUBMqcoUFXVxLghPjB89u3pZynzywN2vvfdmIhJ4fhIN47ifGct7RFtLO2Epe2t7/duN7z33+DNTpdHEiQETsyoDKuJyYfjVP/7d5ZsXTnzkY6AcmAFyUS+OemQsxFkgbVK0J1tAxAisHydiPD46fijnZ72hNMLMhh2WY2+j067mvdZ2XRfr+UNjvdpAYdEcvLd69tgdR54+8flYoQzaU1sCNv1e86f/8vuL106vXv/Dg3c93us2+93aobsem5g9lkQ9ENlUMoo6JobAGG63Oyura9Wx8fr28lJ3NRPmP9zYuLNy4Oljd7evbU6uml6vxp168UC+K1o5NAIyQSUIueIHeUCZCKogZWJRqCTM5sTDvz174OS9Dz0zGPSNDXJhyc/kVRJAGGRT7clkU85n5kRct9fP9gbtTvvm1mp34DY5ONhIpg+ePC032FkeG3XTlW2V0IxF5AUUI2k40qz1NdWlRKqqSIgAZevnJu78ghQ2M+XDY2EgCibrJEniiNgK1GKvqvecRJK4Uqn44AMnnPDMvum337soK53JkEsqnvDfLp09PD322NH7SLG+U9+89uHY1ChGD9XjCYob79z85cdnjgZeSVLOBakqMw8GwxdPvbe0tvsr9f60d7m2u1YoT95xz2eK5WmXREqwCgJS5Z52PpCqEwr8zPz2wnxjIZf1+yJXtPHE1EcOVScTFYnQ2WzOZPMtDd4/d33uaH9yaiJj8X49/vFi++mjVZIIYCgUIuo8S089erzd6Ryam6nXiuMzw0yuHGSLTqK0KM3X/uTZ0epI4hJmolQzExRs2d/obP9y7ZyQGrZN6WPYDRC8emOhaK2J40T14KHpIPSx0Av6vaCs5Js3dnUinL275EUiaRNQiLXm5evd/7rQKeWDuw7MeJmStZ4xXmqQiMSC9noHiBWSylqCiiaT+YlqbmS1s2kU7dXW65fnZ8dmZsPchfW1x+69c3xsZKxYKFRMUBiZ4ImXujdGK+2NwfIrm4OnZjJpvgOwzK2e+9YL188t1PrK5cZLy8vzkkTHHvrS1NwDcdQhsva2rVMVl0YidUBxEo1ki4/ue+D78y8TNJMPXDZf7GY/XRx/fndhcX59hnO3lhrFyfLFZPvxyshzBz59au21AZWnwwAQ1dRNkhPJZ+m7zz00vz344vFqUh+bPPAJhcvmSi4ZggwUnBLnbdJUVSgUREycaPyZQ48+uf/hRCSolnGkuBpu+i2t9jOX3p+fv7nSIzRdPDIy/b0b57pe/df2HRf/bgMl5tR9pD1ZRA+98m+f+vuvD/73BcpkrPXZ+AoiYgIjBYKYmVNEQGyYGarGGIA9m7lr7EhATMOhNuP+ZssKz+XH4oofW/TjYWOp7pYaPKS/e/ftYqZ0H28/v96v95w1txWj8TEcts6807h62a0uXzv73zevvX7xzA83V84bL0iFvlXR4WDgnALqeda5pD/oFwqFVqtp/Zyf9eY3Fx3Fuazn3TPRLfrtneHDhYn3m8tbw36pmO/3+6oy7XvvrSy+tLD4cHbsx53u2Ub42KQ/EDXM6hLOFSf+7JvJ5lru+IPlKFLVxMUgE0ddIiiUReXU629dvHLt1TfeXbq1MhjG1+YXlfna9Zu1ej0aRjduLg4c9ePERUMzHtbGtJE0n73rwfZW7+KtVcqRFL3SSHGuUnzx2umDsHd68doAZEkBEQcidbEUR+mu+1u1RqPda3UHxL4xnmrq2IQ9zz9x7L7l5dV8mBsZKa+srm1u1+av3YzieHl59cr1edmJ4u2egVAck2guX5qn/ppp/cbMwfkzCzcW1hLRxPLhfbNr0rdFeths/OOt9nIjyViDPYwNQV/5+Ssra1sffHDxzbdOt9odY3hPR4LN17727OT4aLfXHR+tzszOOBcncTQ7Ow2VbNYvlSscU62/2+QO20ATYVYjdP3SoleLo8QttZuHDk53d7qTo2NLvaYqPzkx9pcrdKHFT43bjEciykxJkpSKYWWkLOKK+WylUg58T0VSr8YMkzjZ3trd2q07Qb+fDKMkiZOdnd1GvUEqYRDOFqZ6vbjVaPVa7Va774yGXS5msl954vFAeWer7vqyfn3zYHXihSvnO9trD7nNq5cu/+yVt2r1mjFGVVS9qL0QDRprm7UoSnwvgILIgFThrKojomIxX8jnoM7avRItFoqJExhjjOn4iVfIUeIg8MmoSDReHKq758iRL6w/eKpxc/b4VDYXVkq50xcXfnLqjanKMT708aOH8v1BvLVbAxB4Xq5yt2f9ibE+k952nApNxxisIpLL5nzrqYoqpYSRyWY9P8PCVzavX92dL+SCbKGYLRXCYlYEZuCaq/XtzdqB2RnK+7lctrlcy6upTha3Z/LPPDg3bfu1Wm3Y7b7z7unV1c1KdaTf6zXbbZckjWar2+0ZhqjjdHCWJFLI5x584D6AojjZNz0xN7cvjqLxsaqSNfCn7pvQCzTsOYazJAnYhpmZh/dN173RsPDq7uLMzHhcH6jT9npzf7W4sLgdohvH2e81Z74xHUyOj+bzWRXt+NWQIshOuVjy/b3SSMc/TIAKBsMojmMCkjju93riJI6iQb8LlbGwatj4HhkX1S6srb+3Gm104xGP7h0rT1Uu7q7dMTU1DNSOBqaa7dS7SnDWWo124luXt3u1ne2dnRqREBtRDcOcH3jp9IHS/gW2e4KTzd58MpXepKrq+/727s7Wwnaxl11eWwzCvIyO0iAhTqK6Xl1cjrtdAvzA7xneuHCrX2itrK2jGjo3rCfhrj04VkA2nM1kQyH/6NYvh5WJc81uv9uemhwlclAlTm0WNJ0qEqcjkT1DvecADPaPzc51Zm5trIqgNO71pJL3urHnZUdw0Nuv7y9BJSyE+z9yuNPrr3VwfGyUvcymC/4gP6xa7+rS1uz0PpLE7TtgM9nDXqbX7Xq+J05BSMcy9vbG6cwRKkq85wwVbNCfyLcq/mg8iDliHo36kjPdQSFocS7oySCJExfFyTAqFfLtTtvudsezThLvKdu+b/SQH5pqdcTzLTQxI6METOYLRBrHkYgwGxEisCVlIiJQOkGk1I8hhcQEQWmttXGlOZ+plKI4MxjqmcJnJ1qXDrY/jHrluaJzLmktNbv15g62rya12alqrr/z8mbjB3QyWzOHM/219a1okNxz9DCSSEkjhz1TBE4nilD5P7KEue5OdAdhAAAAAElFTkSuQmCC" style="width:22px;height:22px;object-fit:contain;border-radius:3px;"></button>
                </div>
            </div>
            
            <div class="scoreboard">
                <div class="scoreboard-pill">
                    <div class="pill-value" id="sbHole">1</div>
                    <div class="pill-label">Hole</div>
                </div>
                <div class="scoreboard-pill">
                    <div class="pill-value" id="sbPar">-</div>
                    <div class="pill-label">Par</div>
                </div>
                <div class="scoreboard-pill">
                    <div class="pill-value" id="sbYards">-</div>
                    <div class="pill-label">Yards</div>
                </div>
                <div class="scoreboard-pill">
                    <div class="pill-value" id="sbShots">0</div>
                    <div class="pill-label">Shots</div>
                </div>
                <div class="scoreboard-pill">
                    <div class="pill-value" id="sbTotal">E</div>
                    <div class="pill-label">vs Par</div>
                </div>
            </div>
            
            <div class="round-info" id="roundInfo">Round in progress</div>
        </header>
        
        <!-- MAIN CONTENT -->
        <main class="app-main">
            <!-- RANGEFINDER SECTION -->
            <section class="section">
                <h2 class="section-title">Rangefinder</h2>
                
                <div class="rangefinder-display">
                    <div class="distance-row">
                        <div class="distance-main">
                            <div class="distance-label">To Flag</div>
                            <div class="distance-value">
                                <span id="toFlag">--</span><span class="distance-unit">y</span>
                            </div>
                        </div>
                        <div class="accuracy-badge bad" id="accBadge">ACC --</div>
                    </div>
                </div>
                
                <div class="input-row">
                    <span class="input-label">Target</span>
                    <input type="text" class="input-field compact" id="attempt" placeholder="--" inputmode="numeric" maxlength="3" pattern="[0-9]*">
                    <button class="btn btn-primary btn-sm" id="btnCaddy" type="button">Caddy</button>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-secondary" id="btnTee" type="button">Tee</button>
                    <button class="btn btn-secondary" id="btnFlag" type="button">Flag</button>
                    <button class="btn btn-primary" id="btnMark" type="button">ðŸ“ Mark</button>
                    <button class="btn btn-primary" id="btnShot" type="button">Shot</button>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-secondary" id="btnPrevHole" type="button">â—€ Hole</button>
                    <button class="btn btn-blue" id="btnHolePick" type="button">Hole</button>
                    <button class="btn btn-secondary" id="btnNextHole" type="button">Hole â–¶</button>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-danger btn-sm" id="btnPen" type="button">Pen</button>
                    <button class="btn btn-danger btn-sm" id="btnDel" type="button">Del</button>
                    <button class="btn btn-toggle btn-sm" id="btnFwy" type="button">Fwy</button>
                    <button class="btn btn-toggle btn-sm" id="btnGir" type="button">GIR</button>
                </div>
            </section>
            
            <!-- SHOTS SECTION -->
            <section class="section">
                <h2 class="section-title">Shots</h2>
                <div class="shot-list" id="shotsList">
                    <div class="shot-list-empty">No shots yet</div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- CADDY SHEET -->
    <div class="backdrop" id="caddyBackdrop"></div>
    <div class="sheet" id="caddySheet" role="dialog" aria-modal="true" aria-labelledby="caddyTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="caddyTitle">Caddy</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnBagEditor" type="button">Bag</button>
                <button class="btn btn-sm btn-secondary" id="btnCaddyMode" type="button">Carry</button>
                <button class="btn btn-sm btn-secondary" id="btnShowAll" type="button">Show All</button>
                <button class="btn btn-sm btn-secondary" id="btnCloseCaddy" type="button">Close</button>
            </div>
        </div>
        
        <div class="input-row">
            <span class="input-label">Target</span>
            <input type="text" class="input-field compact" id="caddyTarget" inputmode="numeric" maxlength="3" pattern="[0-9]*">
            <button class="btn btn-sm btn-secondary" id="btnResetTarget" type="button">Reset</button>
        </div>
        
        <div class="suggestion-list" id="suggestionList"></div>
    </div>
    
    <!-- BAG EDITOR SHEET -->
    <div class="backdrop" id="bagBackdrop"></div>
    <div class="sheet" id="bagSheet" role="dialog" aria-modal="true" aria-labelledby="bagTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="bagTitle">Bag Editor</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnManageClubs" type="button">Manage Clubs</button>
                <button class="btn btn-sm btn-secondary" id="btnCloseBag" type="button">Close</button>
            </div>
        </div>
        
        <div id="bagNameDisplay" style="font-size: 1rem; font-weight: 700; color: var(--green-400); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--border);"></div>
        
        <div class="input-row">
            <span class="input-label">Club</span>
            <select class="input-field" id="bagClub"></select>
        </div>
        
        <div class="input-row">
            <span class="input-label">Shot Type</span>
            <select class="input-field" id="bagShotType"></select>
        </div>
        
        <div class="input-row">
            <span class="input-label">Carry</span>
            <input type="number" class="input-field compact" id="bagCarry" inputmode="numeric" placeholder="140">
            <span class="input-label">Total</span>
            <input type="number" class="input-field compact" id="bagTotal" inputmode="numeric" placeholder="150">
        </div>
        
        <div class="btn-row">
            <button class="btn btn-primary" id="btnSaveBag" type="button">Save to Bag</button>
        </div>
        
        <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Current Bag</h4>
            <div id="bagMatrix" style="font-size: 0.75rem; color: var(--text-secondary); max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- MANAGE CLUBS & SHOT TYPES SHEET -->
    <div class="backdrop" id="manageClubsBackdrop"></div>
    <div class="sheet" id="manageClubsSheet" role="dialog" aria-modal="true" aria-labelledby="manageClubsTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="manageClubsTitle">Clubs &amp; Shot Types</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnCloseManageClubs" type="button">Done</button>
            </div>
        </div>
        
        <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Clubs</h4>
        <div id="clubList" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: var(--space-3);"></div>
        <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-5);">
            <input type="text" id="newClubInput" class="input-field" placeholder="e.g. 7I, PW, 60Â°" style="flex:1;">
            <button class="btn btn-primary btn-sm" id="btnAddClub" type="button">Add Club</button>
        </div>
        
        <div style="padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Shot Types</h4>
            <div id="shotTypeList" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: var(--space-3);"></div>
            <div style="display: flex; gap: var(--space-2);">
                <input type="text" id="newShotTypeInput" class="input-field" placeholder="e.g. Punch, Chip" style="flex:1;">
                <button class="btn btn-primary btn-sm" id="btnAddShotType" type="button">Add Type</button>
            </div>
        </div>
    </div>
    
    <!-- COURSE SETUP SHEET -->
    <div class="backdrop" id="courseBackdrop"></div>
    <div class="sheet" id="courseSheet" role="dialog" aria-modal="true" aria-labelledby="courseTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="courseTitle">Course Setup</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-primary" id="btnSaveCourse" type="button">Save</button>
                <button class="btn btn-sm btn-secondary" id="btnCloseCourse" type="button">Close</button>
            </div>
        </div>
        
        <div class="input-row">
            <span class="input-label">Course</span>
            <div style="display:flex; gap: var(--space-2); flex:1;">
                <input type="text" class="input-field" id="courseName" placeholder="Course name" style="flex:1;">
                <button class="btn btn-sm btn-secondary" id="btnPickCourse" type="button" style="flex-shrink:0;">â–¼</button>
            </div>
        </div>
        
        <!-- Course picker list (hidden by default) -->
        <div id="coursePickerList" style="display:none; flex-direction:column; gap:4px; margin-bottom: var(--space-3); max-height:180px; overflow-y:auto; border:1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-2); background: var(--bg-card);"></div>
        
        <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Holes</h4>
            <div id="courseHoles" style="display: grid; gap: var(--space-3); max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- EXPORT SHEET â€” choose between CSV download or on-screen report -->
    <div class="backdrop" id="exportBackdrop"></div>
    <div class="sheet" id="exportSheet" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="exportTitle">Export Round</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnCloseExport" type="button">Close</button>
            </div>
        </div>
        <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:var(--space-4);">Choose how to export your round data.</p>
        <div style="display:flex; flex-direction:column; gap:var(--space-3);">
            <button class="btn btn-primary" id="btnDownloadCSV" type="button" style="font-size:1rem; padding:var(--space-4);">
                â¬‡ï¸ Download CSV
                <span style="display:block; font-size:0.7rem; font-weight:500; opacity:0.8; margin-top:2px;">Spreadsheet-ready data file</span>
            </button>
            <button class="btn btn-secondary" id="btnViewReport" type="button" style="font-size:1rem; padding:var(--space-4);">
                ðŸ“„ View Report
                <span style="display:block; font-size:0.7rem; font-weight:500; opacity:0.8; margin-top:2px;">Summary on screen</span>
            </button>
        </div>
    </div>

    <!-- SCORECARD SHEET -->
    <div class="backdrop" id="scorecardBackdrop"></div>
    <div class="sheet" id="scorecardSheet" role="dialog" aria-modal="true" aria-labelledby="scorecardTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="scorecardTitle">Scorecard</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnCloseScorecard" type="button">Close</button>
            </div>
        </div>
        <div id="scorecardContent"></div>
    </div>

    <!-- HOLE PICKER SHEET -->
    <div class="backdrop" id="holeBackdrop"></div>
    <div class="sheet" id="holeSheet" role="dialog" aria-modal="true" aria-labelledby="holeTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="holeTitle">Select Hole</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnCloseHole" type="button">Close</button>
            </div>
        </div>
        <div class="hole-picker-grid" id="holeGrid"></div>
    </div>

    <!-- LIBRARY MANAGEMENT SHEET -->
    <div class="backdrop" id="libraryBackdrop"></div>
    <div class="sheet" id="librarySheet" role="dialog" aria-modal="true" aria-labelledby="libraryTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="libraryTitle">Library</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-primary" id="btnNewRound" type="button">New Round</button>
                <button class="btn btn-sm btn-secondary" id="btnCloseLibrary" type="button">Close</button>
            </div>
        </div>
        
        <div style="margin-bottom: var(--space-4);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                <h4 style="font-size: 0.875rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Bag Library</h4>
                <button class="btn btn-sm btn-secondary" id="btnAddBag" type="button">+ New Bag</button>
            </div>
            <div id="bagLibraryList" style="display: flex; flex-direction: column; gap: var(--space-2);"></div>
        </div>
        
        <div style="margin-bottom: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                <h4 style="font-size: 0.875rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">Course Library</h4>
                <button class="btn btn-sm btn-secondary" id="btnAddCourse" type="button">+ New Course</button>
            </div>
            <div id="courseLibraryList" style="display: flex; flex-direction: column; gap: var(--space-2);"></div>
        </div>
        
        <div style="padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.875rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: var(--space-3);">Import / Export</h4>
            <div class="btn-row">
                <button class="btn btn-secondary btn-sm" id="btnImportBag" type="button">Import Bag</button>
                <button class="btn btn-secondary btn-sm" id="btnImportCourse" type="button">Import Course</button>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary btn-sm" id="btnExportAllBags" type="button">Export All Bags</button>
                <button class="btn btn-secondary btn-sm" id="btnExportAllCourses" type="button">Export All Courses</button>
            </div>
        </div>
    </div>

    <!-- NEW ROUND SETUP SHEET -->
    <div class="backdrop" id="roundSetupBackdrop"></div>
    <div class="sheet" id="roundSetupSheet" role="dialog" aria-modal="true" aria-labelledby="roundSetupTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="roundSetupTitle">New Round</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-secondary" id="btnCancelRound" type="button">Cancel</button>
            </div>
        </div>
        
        <div class="input-row">
            <span class="input-label">Select Bag</span>
            <select class="input-field" id="roundBagSelect"></select>
        </div>
        
        <div class="input-row">
            <span class="input-label">Select Course</span>
            <select class="input-field" id="roundCourseSelect"></select>
        </div>
        
        <div class="btn-row" style="margin-top: var(--space-4);">
            <button class="btn btn-primary" id="btnStartRound" type="button">Start Round</button>
        </div>
    </div>

    <!-- EDIT BAG SHEET -->
    <div class="backdrop" id="editBagBackdrop"></div>
    <div class="sheet" id="editBagSheet" role="dialog" aria-modal="true" aria-labelledby="editBagTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="editBagTitle">Edit Bag</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-primary" id="btnSaveEditBag" type="button">Save</button>
                <button class="btn btn-sm btn-secondary" id="btnCancelEditBag" type="button">Cancel</button>
            </div>
        </div>
        
        <div class="input-row">
            <span class="input-label">Bag Name</span>
            <input type="text" class="input-field" id="editBagName" placeholder="e.g., Summer Bag">
        </div>
        
        <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Club Distances</h4>
            
            <div class="input-row">
                <span class="input-label">Club</span>
                <select class="input-field" id="editBagClub"></select>
            </div>
            
            <div class="input-row">
                <span class="input-label">Shot Type</span>
                <select class="input-field" id="editBagShotType"></select>
            </div>
            
            <div class="input-row">
                <span class="input-label">Carry</span>
                <input type="number" class="input-field compact" id="editBagCarry" inputmode="numeric" placeholder="140">
                <span class="input-label">Total</span>
                <input type="number" class="input-field compact" id="editBagTotal" inputmode="numeric" placeholder="150">
            </div>
            
            <div class="btn-row">
                <button class="btn btn-secondary btn-sm" id="btnAddDistance" type="button">Add to Bag</button>
            </div>
            
            <div id="editBagMatrix" style="margin-top: var(--space-4); max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- EDIT COURSE SHEET -->
    <div class="backdrop" id="editCourseBackdrop"></div>
    <div class="sheet" id="editCourseSheet" role="dialog" aria-modal="true" aria-labelledby="editCourseTitle">
        <div class="sheet-header">
            <h3 class="sheet-title" id="editCourseTitle">Edit Course</h3>
            <div class="sheet-actions">
                <button class="btn btn-sm btn-primary" id="btnSaveEditCourse" type="button">Save</button>
                <button class="btn btn-sm btn-secondary" id="btnCancelEditCourse" type="button">Cancel</button>
            </div>
        </div>
        
        <div class="input-row">
            <span class="input-label">Course Name</span>
            <input type="text" class="input-field" id="editCourseName" placeholder="e.g., Pebble Beach">
        </div>
        
        <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border);">
            <h4 style="font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-3);">Holes</h4>
            <div id="editCourseHoles" style="display: grid; gap: var(--space-3); max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- FILE INPUT (HIDDEN) -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
    /* ===============================================
       SHOT TRACKER v39 - PRODUCTION JAVASCRIPT
       Defensive architecture with clean separation
       =============================================== */
    
    (function() {
        'use strict';
        
        // ============================================
        // CONSTANTS
        // ============================================
        
        const VERSION = 'v40.18';
        const LS_STATE_KEY = 'shotTracker.v39.state';
        const LS_BAG_KEY = 'shotTracker.v39.bag';
        const LS_COURSE_KEY = 'shotTracker.v39.course';
        const LS_BAG_LIBRARY_KEY = 'shotTracker.v40.bagLibrary';
        const LS_COURSE_LIBRARY_KEY = 'shotTracker.v40.courseLibrary';
        
        // Default bag configuration
        const DEFAULT_CLUBS = ['Club?', 'D', '3W', '5W', '7W', '3H', '5H', '4I', '5I', '6I', '7I', '8I', '9I', 'PW', '46', '52', '56', '60', 'PT'];
        const DEFAULT_SHOT_TYPES = ['Type?', 'full', '3/4', '1/2', 'pitch', 'chip', 'putt', 'penalty'];
        const DEFAULT_BAG = {
            'D': { 'full': { carry: 220, total: 240 } },
            '7I': { 'full': { carry: 140, total: 150 }, '3/4': { carry: 125, total: 135 } },
            'PT': { 'putt': { carry: 0, total: 0 } }
        };
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        const Utils = {
            // Safe DOM element getter
            $(id) {
                try {
                    return document.getElementById(id);
                } catch (e) {
                    console.error(`Element not found: ${id}`, e);
                    return null;
                }
            },
            
            // Escape HTML for safe insertion
            escHtml(str) {
                return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            },
            
            // Generate unique ID
            generateId(prefix) {
                return (prefix || 'id') + '-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
            },
            
            // Format ISO date as mm/dd/yy hh:mm
            formatShortDate(iso) {
                if (!iso) return '';
                try {
                    const d = new Date(iso);
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    const yy = String(d.getFullYear()).slice(-2);
                    const hh = String(d.getHours()).padStart(2, '0');
                    const min = String(d.getMinutes()).padStart(2, '0');
                    return mm + '/' + dd + '/' + yy + ' ' + hh + ':' + min;
                } catch (e) {
                    return '';
                }
            },
            
            // Clamp integer value
            clampInt(val, min, max) {
                const n = Number(val);
                if (!isFinite(n)) return null;
                const rounded = Math.round(n);
                if (rounded < min) return min;
                if (rounded > max) return max;
                return rounded;
            },
            
            // Validate yards value
            saneYards(val) {
                const n = Number(val);
                if (!isFinite(n) || n < 0 || n > 1200) return null;
                return Math.round(n);
            },
            
            // Meters to yards conversion
            metersToYards(meters) {
                const n = Number(meters);
                if (!isFinite(n)) return null;
                return n * 1.0936132983;
            },
            
            // Calculate distance between two GPS points
            distanceYards(pointA, pointB) {
                if (!pointA || !pointB) return null;
                
                const R = 6371000; // Earth radius in meters
                const toRad = deg => deg * Math.PI / 180;
                
                const dLat = toRad(pointB.lat - pointA.lat);
                const dLon = toRad(pointB.lon - pointA.lon);
                const lat1 = toRad(pointA.lat);
                const lat2 = toRad(pointB.lat);
                
                const a = Math.sin(dLat / 2) ** 2 + 
                         Math.cos(lat1) * Math.cos(lat2) * 
                         Math.sin(dLon / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const meters = R * c;
                
                const yards = this.metersToYards(meters);
                return this.saneYards(yards);
            },
            
            // ISO timestamp
            nowISO() {
                return new Date().toISOString();
            },
            
            // Generate UUID
            uuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            
            // Toast notification
            toast(message, duration = 1000) {
                try {
                    const toast = document.createElement('div');
                    toast.className = 'toast';
                    toast.textContent = message;
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        try {
                            toast.remove();
                        } catch (e) {
                            // Ignore removal errors
                        }
                    }, duration);
                } catch (e) {
                    console.error('Toast error:', e);
                }
            }
        };
        
        // ============================================
        // STORAGE MANAGER
        // ============================================
        
        const Storage = {
            load(key) {
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (e) {
                    console.error(`Storage load error for ${key}:`, e);
                    return null;
                }
            },
            
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Storage save error for ${key}:`, e);
                    return false;
                }
            }
        };
        
        // ============================================
        // LIBRARY MANAGER
        // ============================================
        
        const Library = {
            // === BAGS ===
            
            getBags() {
                let bags = Storage.load(LS_BAG_LIBRARY_KEY) || [];
                
                // First-time migration: load from old v39 bag key
                if (bags.length === 0) {
                    const oldBag = Storage.load(LS_BAG_KEY);
                    if (oldBag) {
                        // Migrate existing bag to library
                        bags.push({
                            id: 'default-bag',
                            name: 'My Bag',
                            clubs: oldBag.clubs ? oldBag.clubs.slice() : DEFAULT_CLUBS.slice(),
                            shotTypes: oldBag.shotTypes ? oldBag.shotTypes.slice() : DEFAULT_SHOT_TYPES.slice(),
                            data: oldBag.data ? JSON.parse(JSON.stringify(oldBag.data)) : JSON.parse(JSON.stringify(DEFAULT_BAG)),
                            created: Utils.nowISO()
                        });
                    } else {
                        // Create default bag from scratch
                        bags.push({
                            id: 'default-bag',
                            name: 'My Bag',
                            clubs: DEFAULT_CLUBS.slice(),
                            shotTypes: DEFAULT_SHOT_TYPES.slice(),
                            data: JSON.parse(JSON.stringify(DEFAULT_BAG)),
                            created: Utils.nowISO()
                        });
                    }
                    Storage.save(LS_BAG_LIBRARY_KEY, bags);
                }
                
                return bags;
            },
            
            saveBags(bags) {
                Storage.save(LS_BAG_LIBRARY_KEY, bags);
            },
            
            getBag(id) {
                const bags = this.getBags();
                return bags.find(b => b.id === id) || null;
            },
            
            saveBag(bag) {
                const bags = this.getBags();
                const index = bags.findIndex(b => b.id === bag.id);
                
                if (index >= 0) {
                    bags[index] = bag;
                } else {
                    bags.push(bag);
                }
                
                this.saveBags(bags);
            },
            
            deleteBag(id) {
                if (id === 'default-bag') {
                    Utils.toast('Cannot delete default bag');
                    return false;
                }
                
                const bags = this.getBags().filter(b => b.id !== id);
                this.saveBags(bags);
                return true;
            },
            
            // === COURSES ===
            
            getCourses() {
                let courses = Storage.load(LS_COURSE_LIBRARY_KEY) || [];
                
                // First-time migration: load from old v39 course key
                if (courses.length === 0) {
                    const oldCourse = Storage.load(LS_COURSE_KEY);
                    if (oldCourse) {
                        // Migrate existing course to library
                        courses.push({
                            id: 'default-course',
                            name: oldCourse.name || 'My Course',
                            holes: oldCourse.holes && Array.isArray(oldCourse.holes) 
                                ? oldCourse.holes.map((h, i) => ({
                                    hole: i + 1,
                                    par: h.par || 4,
                                    yards: h.yards || 0,
                                    hcp: h.hcp || (i + 1),
                                    teeGPS: h.teeGPS || null,
                                    flagGPS: h.flagGPS || null
                                  }))
                                : Array.from({length: 18}, (_, i) => ({
                                    hole: i + 1, par: 4, yards: 0, hcp: i + 1,
                                    teeGPS: null, flagGPS: null
                                  })),
                            created: Utils.nowISO()
                        });
                    } else {
                        // Create default course from scratch
                        courses.push({
                            id: 'default-course',
                            name: 'My Course',
                            holes: Array.from({length: 18}, (_, i) => ({
                                hole: i + 1, par: 4, yards: 0, hcp: i + 1,
                                teeGPS: null, flagGPS: null
                            })),
                            created: Utils.nowISO()
                        });
                    }
                    Storage.save(LS_COURSE_LIBRARY_KEY, courses);
                }
                
                return courses;
            },
            
            saveCourses(courses) {
                Storage.save(LS_COURSE_LIBRARY_KEY, courses);
            },
            
            getCourse(id) {
                const courses = this.getCourses();
                return courses.find(c => c.id === id) || null;
            },
            
            saveCourse(course) {
                const courses = this.getCourses();
                const index = courses.findIndex(c => c.id === course.id);
                
                if (index >= 0) {
                    courses[index] = course;
                } else {
                    courses.push(course);
                }
                
                this.saveCourses(courses);
            },
            
            deleteCourse(id) {
                if (id === 'default-course') {
                    Utils.toast('Cannot delete default course');
                    return false;
                }
                
                const courses = this.getCourses().filter(c => c.id !== id);
                this.saveCourses(courses);
                return true;
            }
        };
        
        // ============================================
        // GPS MANAGER
        // ============================================
        
        const GPS = {
            watchId: null,
            lastFix: null,
            
            start() {
                if (!navigator.geolocation) {
                    console.warn('Geolocation not supported');
                    return;
                }
                
                try {
                    this.watchId = navigator.geolocation.watchPosition(
                        position => this.onSuccess(position),
                        error => this.onError(error),
                        {
                            enableHighAccuracy: true,
                            maximumAge: 5000,
                            timeout: 10000
                        }
                    );
                } catch (e) {
                    console.error('GPS start error:', e);
                }
            },
            
            stop() {
                if (this.watchId !== null) {
                    try {
                        navigator.geolocation.clearWatch(this.watchId);
                        this.watchId = null;
                    } catch (e) {
                        console.error('GPS stop error:', e);
                    }
                }
            },
            
            onSuccess(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const acc = position.coords.accuracy;
                
                // Sanity check
                if (!isFinite(lat) || !isFinite(lon) || !isFinite(acc)) {
                    return;
                }
                
                const accY = Utils.saneYards(Utils.metersToYards(acc));
                
                this.lastFix = {
                    lat,
                    lon,
                    acc,
                    accY,
                    timestamp: Date.now()
                };
                
                // Trigger UI update
                if (window.App && window.App.render) {
                    window.App.render();
                }
            },
            
            onError(error) {
                console.warn('GPS error:', error.message);
            },
            
            getCurrentPosition() {
                if (!this.lastFix) return null;
                return {
                    lat: this.lastFix.lat,
                    lon: this.lastFix.lon
                };
            }
        };
        
        // ============================================
        // STATE MANAGER
        // ============================================
        
        const State = {
            version: VERSION,
            round: {
                startedAt: Utils.nowISO()
            },
            holeIndex: 0,
            holes: [],
            currentBagId: null,  // v40.1: Track which bag is active
            currentCourseId: null,  // v40.1: Track which course is active
            bag: {
                clubs: DEFAULT_CLUBS.slice(),
                shotTypes: DEFAULT_SHOT_TYPES.slice(),
                data: JSON.parse(JSON.stringify(DEFAULT_BAG))
            },
            ui: {
                caddyMode: 'carry',
                showAll: false
            },
            
            init() {
                // Try to load from storage
                const saved = Storage.load(LS_STATE_KEY);
                if (saved && saved.version === VERSION) {
                    Object.assign(this, saved);
                } else {
                    // Initialize fresh state
                    this.initHoles();
                }
                
                // v40.1: Load from library
                this.loadFromLibrary();
                
                // Load bag override if exists (backward compat)
                this.loadBag();
                
                // Ensure state integrity
                this.validate();
                
                // Save
                this.save();
            },
            
            loadFromLibrary() {
                // v40.1: Load bag and course from library
                const bags = Library.getBags();
                const courses = Library.getCourses();
                
                // Set default IDs if not set
                if (!this.currentBagId || !Library.getBag(this.currentBagId)) {
                    this.currentBagId = (bags[0] && bags[0].id) || 'default-bag';
                }
                
                if (!this.currentCourseId || !Library.getCourse(this.currentCourseId)) {
                    this.currentCourseId = (courses[0] && courses[0].id) || 'default-course';
                }
                
                // Load active bag into State.bag
                const activeBag = Library.getBag(this.currentBagId);
                if (activeBag) {
                    this.bag = {
                        name: activeBag.name || '',
                        clubs: activeBag.clubs.slice(),
                        shotTypes: activeBag.shotTypes.slice(),
                        data: JSON.parse(JSON.stringify(activeBag.data))
                    };
                }
                
                // Load active course data into State.holes
                const activeCourse = Library.getCourse(this.currentCourseId);
                if (activeCourse && activeCourse.holes) {
                    activeCourse.holes.forEach((ch, idx) => {
                        if (this.holes[idx]) {
                            this.holes[idx].par = ch.par || this.holes[idx].par;
                            this.holes[idx].yards = ch.yards || this.holes[idx].yards;
                            this.holes[idx].hcp = ch.hcp || this.holes[idx].hcp;
                            // Load tee/flag GPS if available and not already set
                            if (ch.teeGPS && !this.holes[idx].tee) {
                                this.holes[idx].tee = ch.teeGPS;
                            }
                            if (ch.flagGPS && !this.holes[idx].flag) {
                                this.holes[idx].flag = ch.flagGPS;
                            }
                        }
                    });
                }
            },
            
            initHoles() {
                this.holes = Array.from({ length: 18 }, (_, i) => ({
                    hole: i + 1,
                    par: 0,
                    yards: 0,
                    hcp: 0,
                    tee: null,
                    flag: null,
                    teePending: false,
                    flagPending: false,
                    fwy: false,
                    gir: false,
                    shots: []
                }));
            },
            
            validate() {
                // Ensure holes array
                if (!Array.isArray(this.holes) || this.holes.length !== 18) {
                    this.initHoles();
                }
                
                // Ensure hole index in bounds
                if (this.holeIndex < 0 || this.holeIndex >= 18) {
                    this.holeIndex = 0;
                }
                
                // Ensure bag structure
                if (!this.bag || !Array.isArray(this.bag.clubs)) {
                    this.bag = {
                        clubs: DEFAULT_CLUBS.slice(),
                        shotTypes: DEFAULT_SHOT_TYPES.slice(),
                        data: JSON.parse(JSON.stringify(DEFAULT_BAG))
                    };
                }
                
                // Load course data if exists
                this.loadCourseData();
            },
            
            loadCourseData() {
                const courseData = Storage.load(LS_COURSE_KEY);
                if (courseData) {
                    this.courseName = courseData.name || '';
                    if (courseData.holes && Array.isArray(courseData.holes)) {
                        courseData.holes.forEach((ch, idx) => {
                            if (this.holes[idx]) {
                                this.holes[idx].par = ch.par || this.holes[idx].par;
                                this.holes[idx].yards = ch.yards || this.holes[idx].yards;
                                this.holes[idx].hcp = ch.hcp || this.holes[idx].hcp;
                                // Load tee/flag GPS if available
                                if (ch.teeGPS && !this.holes[idx].tee) {
                                    this.holes[idx].tee = ch.teeGPS;
                                }
                                if (ch.flagGPS && !this.holes[idx].flag) {
                                    this.holes[idx].flag = ch.flagGPS;
                                }
                            }
                        });
                    }
                }
            },
            
            saveCourseData(courseName, holesData) {
                Storage.save(LS_COURSE_KEY, {
                    name: courseName,
                    holes: holesData
                });
                this.courseName = courseName;
            },
            
            // Save tee/flag GPS to course for future rounds
            saveTeeToLibrary(holeIndex, gps) {
                // v40.2: Save tee GPS to course library (not old LS_COURSE_KEY)
                const course = Library.getCourse(this.currentCourseId);
                if (!course) return;
                
                if (!course.holes[holeIndex]) {
                    course.holes[holeIndex] = { 
                        hole: holeIndex + 1, par: 4, yards: 0, hcp: holeIndex + 1,
                        teeGPS: null, flagGPS: null
                    };
                }
                
                course.holes[holeIndex].teeGPS = gps;
                Library.saveCourse(course);
            },
            
            saveFlagToLibrary(holeIndex, gps) {
                // v40.2: Save flag GPS to course library (not old LS_COURSE_KEY)
                const course = Library.getCourse(this.currentCourseId);
                if (!course) return;
                
                if (!course.holes[holeIndex]) {
                    course.holes[holeIndex] = { 
                        hole: holeIndex + 1, par: 4, yards: 0, hcp: holeIndex + 1,
                        teeGPS: null, flagGPS: null
                    };
                }
                
                course.holes[holeIndex].flagGPS = gps;
                Library.saveCourse(course);
            },
            
            save() {
                Storage.save(LS_STATE_KEY, {
                    version: this.version,
                    round: this.round,
                    holeIndex: this.holeIndex,
                    holes: this.holes,
                    currentBagId: this.currentBagId,  // v40.1
                    currentCourseId: this.currentCourseId,  // v40.1
                    ui: this.ui
                });
            },
            
            loadBag() {
                const savedBag = Storage.load(LS_BAG_KEY);
                if (savedBag) {
                    if (Array.isArray(savedBag.clubs)) {
                        this.bag.clubs = savedBag.clubs.slice();
                    }
                    if (Array.isArray(savedBag.shotTypes)) {
                        this.bag.shotTypes = savedBag.shotTypes.slice();
                    }
                    if (savedBag.data && typeof savedBag.data === 'object') {
                        this.bag.data = savedBag.data;
                    }
                }
            },
            
            saveBag() {
                Storage.save(LS_BAG_KEY, {
                    clubs: this.bag.clubs,
                    shotTypes: this.bag.shotTypes,
                    data: this.bag.data
                });
            },
            
            currentHole() {
                return this.holes[this.holeIndex] || this.holes[0];
            },
            
            totalShots() {
                return this.holes.reduce((sum, hole) => sum + hole.shots.length, 0);
            }
        };
        
        // ============================================
        // CADDY ENGINE
        // ============================================
        
        const Caddy = {
            getSuggestions(targetYards, mode = 'carry', showAll = false) {
                const suggestions = [];
                const bag = State.bag.data;
                const clubs = State.bag.clubs;
                
                for (const club of clubs) {
                    if (club === 'Club?') continue;
                    if (!bag[club]) continue;
                    
                    const shotTypes = bag[club];
                    for (const shotType in shotTypes) {
                        const distances = shotTypes[shotType];
                        if (!distances) continue;
                        
                        const dist = mode === 'carry' ? distances.carry : distances.total;
                        if (!dist) continue;
                        
                        const diff = Math.abs(dist - targetYards);
                        
                        if (showAll || diff <= 10) {
                            suggestions.push({
                                club,
                                shotType,
                                carry: distances.carry,
                                total: distances.total,
                                distance: dist,
                                diff
                            });
                        }
                    }
                }
                
                // Sort by difference
                suggestions.sort((a, b) => a.diff - b.diff);
                
                return suggestions;
            }
        };
        
        // ============================================
        // UI MANAGER
        // ============================================
        
        const UI = {
            els: {},
            editingLock: false, // Prevents renders while user is editing
            
            cacheElements() {
                const ids = [
                    'sbHole', 'sbShots', 'sbTotal', 'sbPar', 'sbYards',
                    'roundInfo', 'toFlag', 'accBadge', 'attempt',
                    'btnTee', 'btnFlag', 'btnShot', 'btnMark',
                    'btnPrevHole', 'btnHolePick', 'btnNextHole',
                    'btnPen', 'btnDel', 'btnFwy', 'btnGir',
                    'btnCaddy', 'btnSettings', 'btnExport', 'btnLibrary', 'btnBagHeader', 'btnNewRoundHeader',
                    'btnScorecard', 'scorecardBackdrop', 'scorecardSheet', 'btnCloseScorecard', 'scorecardContent',
                    'exportBackdrop', 'exportSheet', 'btnCloseExport', 'btnDownloadCSV', 'btnViewReport',
                    'shotsList',
                    'caddyBackdrop', 'caddySheet', 'btnCloseCaddy',
                    'btnCaddyMode', 'btnShowAll', 'caddyTarget', 'btnResetTarget',
                    'suggestionList', 'btnBagEditor',
                    'holeBackdrop', 'holeSheet', 'btnCloseHole', 'holeGrid',
                    'bagBackdrop', 'bagSheet', 'btnCloseBag', 'bagClub', 'bagShotType',
                    'bagCarry', 'bagTotal', 'btnSaveBag', 'bagMatrix', 'btnManageClubs', 'bagNameDisplay',
                    'manageClubsBackdrop', 'manageClubsSheet', 'btnCloseManageClubs',
                    'clubList', 'shotTypeList', 'newClubInput', 'newShotTypeInput',
                    'btnAddClub', 'btnAddShotType',
                    'courseBackdrop', 'courseSheet', 'btnCloseCourse', 'btnSaveCourse',
                    'courseName', 'courseHoles', 'btnPickCourse', 'coursePickerList',
                    'libraryBackdrop', 'librarySheet', 'btnCloseLibrary',
                    'bagLibraryList', 'courseLibraryList',
                    'btnImportBag', 'btnImportCourse',
                    'btnExportAllBags', 'btnExportAllCourses',
                    'roundSetupBackdrop', 'roundSetupSheet',
                    'btnNewRound', 'btnNewRoundHeader', 'btnCancelRound',
                    'btnStartRound', 'roundBagSelect', 'roundCourseSelect'
                ];
                
                ids.forEach(id => {
                    this.els[id] = Utils.$(id);
                });
            },
            
            render() {
                // Don't render if user is actively editing an input
                if (this.editingLock) return;
                
                this.renderScoreboard();
                this.renderRangefinder();
                this.renderButtons();
                this.renderShots();
            },
            
            renderScoreboard() {
                const hole = State.currentHole();
                const holeNum = State.holeIndex + 1;
                const shotsThisHole = hole.shots.length;
                
                // Calculate cumulative score vs par for all holes played.
                // Par is read from State.holes[i].par â€” the single source of truth.
                // Holes with no par set (0) are excluded from the calculation.
                let relPar = 0;
                State.holes.forEach(function(h) {
                    if (h.shots.length > 0 && h.par > 0) {
                        relPar += h.shots.length - h.par;
                    }
                });
                const relParText = relPar === 0 ? 'E' : (relPar > 0 ? '+' + relPar : '' + relPar);
                
                if (this.els.sbHole) this.els.sbHole.textContent = holeNum;
                if (this.els.sbShots) this.els.sbShots.textContent = shotsThisHole;
                if (this.els.sbPar) this.els.sbPar.textContent = hole.par || '-';
                if (this.els.sbYards) this.els.sbYards.textContent = hole.yards || '-';
                
                if (this.els.sbTotal) {
                    this.els.sbTotal.textContent = relParText;
                    // Under par = red (hot!), over par / even = white
                    this.els.sbTotal.style.color = relPar < 0 ? 'var(--red)' : '';
                }
                
                if (this.els.roundInfo) {
                    const date = new Date(State.round.startedAt);
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    const time = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    const courseName = State.courseName ? State.courseName : ((State.course && State.course.name) ? State.course.name : 'No Course');
                    const bagName = (State.bag && State.bag.name) ? State.bag.name : '';
                    const infoStr = bagName ? courseName + ' Â· ' + bagName + ' Â· ' + mm + '/' + dd + ' ' + time : courseName + ' Â· ' + mm + '/' + dd + ' ' + time;
                    this.els.roundInfo.textContent = infoStr;
                }
            },
            
            renderRangefinder() {
                const toFlagYards = this.getToFlagYards();
                
                if (this.els.toFlag) {
                    this.els.toFlag.textContent = toFlagYards !== null ? toFlagYards : '--';
                }
                
                if (this.els.accBadge) {
                    const accY = GPS.lastFix ? GPS.lastFix.accY : null;
                    this.els.accBadge.classList.remove('good', 'warn', 'bad');
                    
                    if (accY !== null) {
                        this.els.accBadge.textContent = `Â±${accY}y`;
                        if (accY <= 10) {
                            this.els.accBadge.classList.add('good');
                        } else if (accY <= 30) {
                            this.els.accBadge.classList.add('warn');
                        } else {
                            this.els.accBadge.classList.add('bad');
                        }
                    } else {
                        this.els.accBadge.textContent = 'ACC --';
                        this.els.accBadge.classList.add('bad');
                    }
                }
                
                // Ensure attempt field has current distance
                this.ensureAttempt();
            },
            
            renderButtons() {
                const hole = State.currentHole();
                
                // Tee button - green when set
                if (this.els.btnTee) {
                    this.els.btnTee.classList.toggle('lit', !!hole.tee);
                    this.els.btnTee.classList.remove('btn-pending');
                }
                
                // Flag button - green when set
                if (this.els.btnFlag) {
                    this.els.btnFlag.classList.toggle('lit', !!hole.flag);
                    this.els.btnFlag.classList.remove('btn-pending');
                }
                
                // v40.2: Mark button - AMBER when there are pending shots waiting to be marked
                if (this.els.btnMark) {
                    const hasPendingShots = hole.shots.some(s => s.positionPending);
                    this.els.btnMark.classList.toggle('btn-pending', hasPendingShots);
                }
                
                // Fairway / GIR toggles
                if (this.els.btnFwy) {
                    this.els.btnFwy.classList.toggle('active', !!hole.fwy);
                }
                if (this.els.btnGir) {
                    this.els.btnGir.classList.toggle('active', !!hole.gir);
                }
            },
            
            renderShots() {
                if (!this.els.shotsList) return;
                
                const hole = State.currentHole();
                this.els.shotsList.innerHTML = '';
                
                if (!hole.shots.length) {
                    const empty = document.createElement('div');
                    empty.className = 'shot-list-empty';
                    empty.textContent = 'No shots yet';
                    this.els.shotsList.appendChild(empty);
                    return;
                }
                
                hole.shots.forEach((shot, idx) => {
                    const item = this.createShotItem(shot, idx);
                    this.els.shotsList.appendChild(item);
                });
            },
            
            createShotItem(shot, idx) {
                const item = document.createElement('div');
                item.className = 'shot-item';
                
                const left = document.createElement('div');
                left.className = 'shot-left';
                
                const number = document.createElement('div');
                number.className = 'shot-number';
                number.textContent = `#${idx + 1}`;
                
                const clubSelect = document.createElement('select');
                clubSelect.className = 'shot-select';
                clubSelect.disabled = !!shot.penalty;
                State.bag.clubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club;
                    option.textContent = club;
                    clubSelect.appendChild(option);
                });
                clubSelect.value = shot.club || 'Club?';
                
                // Track focus to prevent interference
                clubSelect.addEventListener('focus', () => {
                    clubSelect.dataset.editing = 'true';
                    UI.editingLock = true; // Lock UI renders
                });
                
                clubSelect.addEventListener('blur', () => {
                    setTimeout(() => {
                        delete clubSelect.dataset.editing;
                        UI.editingLock = false; // Unlock UI renders
                    }, 300);
                });
                
                clubSelect.addEventListener('change', () => {
                    shot.club = clubSelect.value;
                    State.save();
                });
                
                const typeSelect = document.createElement('select');
                typeSelect.className = 'shot-select';
                typeSelect.disabled = !!shot.penalty;
                State.bag.shotTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
                typeSelect.value = shot.shotType || 'Type?';
                
                // Track focus to prevent interference
                typeSelect.addEventListener('focus', () => {
                    typeSelect.dataset.editing = 'true';
                    UI.editingLock = true; // Lock UI renders
                });
                
                typeSelect.addEventListener('blur', () => {
                    setTimeout(() => {
                        delete typeSelect.dataset.editing;
                        UI.editingLock = false; // Unlock UI renders
                    }, 300);
                });
                
                typeSelect.addEventListener('change', () => {
                    shot.shotType = typeSelect.value;
                    State.save();
                });
                
                left.appendChild(number);
                left.appendChild(clubSelect);
                left.appendChild(typeSelect);
                
                const right = document.createElement('div');
                right.style.display = 'flex';
                right.style.alignItems = 'center';
                right.style.gap = 'var(--space-1)';
                
                const distInput = document.createElement('input');
                distInput.className = 'shot-input';
                distInput.type = 'number';
                distInput.inputMode = 'numeric';
                distInput.disabled = !!shot.penalty;
                distInput.value = shot.penalty ? '' : String(shot.distance || 0);
                distInput.placeholder = shot.shotType === 'putt' ? 'ft' : 'y';
                
                // Track focus to keep input open
                distInput.addEventListener('focus', () => {
                    distInput.dataset.editing = 'true';
                    UI.editingLock = true; // Lock UI renders
                });
                
                distInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        delete distInput.dataset.editing;
                        UI.editingLock = false; // Unlock UI renders
                    }, 300);
                });
                
                distInput.addEventListener('change', () => {
                    const val = Utils.saneYards(distInput.value);
                    shot.distance = val !== null ? val : (shot.distance || 0);
                    State.save();
                    // Don't call UI.render() here - it rebuilds the dropdowns
                });
                
                // Add unit label
                const unitLabel = document.createElement('span');
                unitLabel.style.fontSize = '0.75rem';
                unitLabel.style.fontWeight = '600';
                unitLabel.style.color = 'var(--text-muted)';
                unitLabel.textContent = shot.shotType === 'putt' ? 'ft' : 'y';
                
                // Position indicator
                const posIndicator = document.createElement('span');
                posIndicator.style.fontSize = '0.875rem';
                posIndicator.title = shot.positionPending ? 'Awaiting Mark Landing' : (shot.position ? 'GPS recorded' : 'No GPS');
                posIndicator.textContent = shot.positionPending ? 'â³' : (shot.position ? 'ðŸ“' : '');
                
                if (shot.penalty) {
                    const penaltyLabel = document.createElement('span');
                    penaltyLabel.className = 'shot-distance';
                    penaltyLabel.style.color = 'var(--red)';
                    penaltyLabel.textContent = 'PENALTY';
                    right.appendChild(penaltyLabel);
                } else {
                    right.appendChild(distInput);
                    right.appendChild(unitLabel);
                    right.appendChild(posIndicator);
                }
                
                item.appendChild(left);
                item.appendChild(right);
                
                return item;
            },
            
            getToFlagYards() {
                const hole = State.currentHole();
                if (!hole.flag) return null;
                
                const currentPos = GPS.getCurrentPosition();
                if (!currentPos) return null;
                
                return Utils.distanceYards(currentPos, hole.flag);
            },
            
            ensureAttempt() {
                if (!this.els.attempt) return;
                
                // Always sync attempt with toFlag if empty
                const current = this.els.attempt.value.trim();
                const toFlag = this.getToFlagYards();
                
                if (current === '' && toFlag !== null) {
                    this.els.attempt.value = String(toFlag);
                }
            },
            
            // Get distance from last shot position or tee to current position
            getDistanceFromLastPosition() {
                const hole = State.currentHole();
                const currentPos = GPS.getCurrentPosition();
                
                if (!currentPos) return null;
                
                // If no shots yet, measure from tee
                if (hole.shots.length === 0) {
                    if (!hole.tee) return null;
                    return Utils.distanceYards(hole.tee, currentPos);
                }
                
                // Measure from last shot position
                const lastShot = hole.shots[hole.shots.length - 1];
                if (!lastShot.position) return null;
                
                return Utils.distanceYards(lastShot.position, currentPos);
            }
        };
        
        // ============================================
        // ACTIONS
        // ============================================
        
        const Actions = {
            toggleTee() {
                const hole = State.currentHole();
                const currentPos = GPS.getCurrentPosition();
                
                // v40.2: Block if shots already recorded on this hole
                if (hole.shots.length > 0) {
                    Utils.toast('Cannot change tee - shots already recorded');
                    return;
                }
                
                if (!currentPos) {
                    hole.teePending = true;
                    State.save();
                    UI.render();
                    Utils.toast('Waiting for GPS...');
                    return;
                }
                
                // Set or update tee position
                const gps = { lat: currentPos.lat, lon: currentPos.lon };
                hole.tee = gps;
                hole.teePending = false;
                
                // v40.2: Save to course library (not old key)
                State.saveTeeToLibrary(State.holeIndex, gps);
                
                State.save();
                UI.render();
                Utils.toast(hole.tee ? 'Tee updated' : 'Tee set');
            },
            
            toggleFlag() {
                const hole = State.currentHole();
                const currentPos = GPS.getCurrentPosition();
                
                if (!currentPos) {
                    hole.flagPending = true;
                    State.save();
                    UI.render();
                    Utils.toast('Waiting for GPS...');
                    return;
                }
                
                // Set or update flag position
                const gps = { lat: currentPos.lat, lon: currentPos.lon };
                hole.flag = gps;
                hole.flagPending = false;
                
                // v40.2: Save to course library (not old key)
                State.saveFlagToLibrary(State.holeIndex, gps);
                
                State.save();
                UI.render();
                Utils.toast(hole.flag ? 'Flag updated' : 'Flag set');
            },
            
            addShot(options = {}) {
                const hole = State.currentHole();
                
                // Get distance from attempt field (user can override GPS)
                const attemptVal = UI.els.attempt ? UI.els.attempt.value.trim() : '';
                const distance = attemptVal ? Utils.saneYards(attemptVal) : 0;
                
                const shot = {
                    club: options.club || 'Club?',
                    shotType: options.shotType || 'Type?',
                    distance: distance || 0,
                    targetDistance: distance || 0,  // What they aimed for
                    actualDistance: null,  // Calculated after marking landing
                    penalty: !!options.penalty,
                    position: null,  // ALWAYS null - GPS captured by Mark Landing
                    positionPending: true,  // ALWAYS pending until Mark Landing
                    timestamp: Utils.nowISO()
                };
                
                hole.shots.push(shot);
                
                // Clear attempt field
                if (UI.els.attempt) {
                    UI.els.attempt.value = '';
                }
                
                State.save();
                UI.render();
                Utils.toast('Shot added - Mark landing when you reach the ball');
            },
            
            addPenalty() {
                this.addShot({ club: 'Penalty', shotType: 'penalty', penalty: true });
            },
            
            markLanding() {
                const hole = State.currentHole();
                const currentPos = GPS.getCurrentPosition();
                
                if (!currentPos) {
                    Utils.toast('No GPS signal');
                    return;
                }
                
                const gps = { lat: currentPos.lat, lon: currentPos.lon };
                
                // --- Check for pending shots (FIFO - mark FIRST pending) ---
                const pendingShots = hole.shots.filter(s => s.positionPending);
                const firstPending = hole.shots.find(s => s.positionPending);
                
                if (firstPending) {
                    // Find index of this shot to calculate distance from previous
                    const shotIndex = hole.shots.indexOf(firstPending);
                    
                    // Update with GPS position
                    firstPending.position = gps;
                    firstPending.positionPending = false;
                    
                    // Calculate actual distance from previous shot or tee
                    const prevShot = shotIndex > 0 ? hole.shots[shotIndex - 1] : null;
                    const prevPos = prevShot ? prevShot.position : hole.tee;
                    
                    if (prevPos) {
                        const dist = Utils.distanceYards(prevPos, currentPos);
                        if (dist !== null) firstPending.actualDistance = dist;
                    }
                    
                    State.save();
                    UI.render();
                    
                    // Toast with count of remaining pending shots
                    const remainingCount = pendingShots.length - 1;
                    const msg = remainingCount > 0 
                        ? `Shot #${shotIndex + 1} marked âœ… (${remainingCount} more pending)`
                        : `Shot #${shotIndex + 1} marked âœ…`;
                    Utils.toast(msg);
                    return;
                }
                
                // --- No pending shot: check if tee is set ---
                if (!hole.tee) {
                    // Option B: treat this as setting tee + recording shot #1
                    hole.tee = gps;
                    State.saveTeeToLibrary(State.holeIndex, gps);
                    
                    const shot = {
                        club: 'Club?',
                        shotType: 'Type?',
                        distance: 0,
                        targetDistance: 0,
                        actualDistance: 0,
                        penalty: false,
                        position: gps,
                        positionPending: false,
                        timestamp: Utils.nowISO()
                    };
                    hole.shots.push(shot);
                    
                    State.save();
                    UI.render();
                    Utils.toast('Tee set â†’ Shot #1 recorded. Enter distance manually.');
                    return;
                }
                
                // --- Normal case: create new shot at landing position ---
                // Get previous position (last shot or tee)
                const shots = hole.shots;
                const prevPos = shots.length > 0 
                    ? shots[shots.length - 1].position 
                    : hole.tee;
                
                const dist = prevPos ? Utils.distanceYards(prevPos, currentPos) : 0;
                
                const shot = {
                    club: 'Club?',
                    shotType: 'Type?',
                    distance: dist || 0,
                    targetDistance: null,
                    actualDistance: dist || 0,
                    penalty: false,
                    position: gps,
                    positionPending: false,
                    timestamp: Utils.nowISO()
                };
                
                hole.shots.push(shot);
                
                State.save();
                UI.render();
                Utils.toast('Shot recorded ðŸ“' + (dist ? ' Â· ' + dist + 'y' : ''));
            },
            
            deleteLastShot() {
                const hole = State.currentHole();
                if (!hole.shots.length) {
                    Utils.toast('No shots to delete');
                    return;
                }
                
                hole.shots.pop();
                State.save();
                UI.render();
                Utils.toast('Shot deleted');
            },
            
            toggleFwy() {
                const hole = State.currentHole();
                hole.fwy = !hole.fwy;
                State.save();
                UI.render();
            },
            
            toggleGir() {
                const hole = State.currentHole();
                hole.gir = !hole.gir;
                State.save();
                UI.render();
            },
            
            prevHole() {
                if (State.holeIndex > 0) {
                    State.holeIndex--;
                    State.save();
                    UI.render();
                }
            },
            
            nextHole() {
                if (State.holeIndex < 17) {
                    State.holeIndex++;
                    State.save();
                    UI.render();
                }
            },
            
            gotoHole(index) {
                if (index >= 0 && index < 18) {
                    State.holeIndex = index;
                    State.save();
                    UI.render();
                }
            }
        };
        
        // ============================================
        // CADDY UI
        // ============================================
        
        const CaddyUI = {
            open() {
                // Close all other sheets first
                this.closeAllOtherSheets();
                
                // Use Attempt field value (user can override before opening Caddy)
                const attemptVal = UI.els.attempt ? UI.els.attempt.value.trim() : '';
                const toFlag = UI.getToFlagYards();
                const targetDistance = attemptVal || (toFlag !== null ? String(toFlag) : '');
                
                if (UI.els.caddyTarget) {
                    UI.els.caddyTarget.value = targetDistance;
                }
                
                // Set button text based on current state (show current, not toggle)
                if (UI.els.btnShowAll) {
                    UI.els.btnShowAll.textContent = State.ui.showAll ? 'Show All' : 'Within 10';
                }
                
                this.show();
                this.render();
            },
            
            close() {
                this.hide();
            },
            
            closeAllOtherSheets() {
                // Hide all other sheets/backdrops
                if (BagEditorUI) BagEditorUI.hide();
                if (CourseSetupUI) CourseSetupUI.hide();
                if (HolePickerUI) HolePickerUI.hide();
            },
            
            show() {
                if (UI.els.caddyBackdrop) {
                    UI.els.caddyBackdrop.classList.add('active');
                }
                if (UI.els.caddySheet) {
                    UI.els.caddySheet.classList.add('active');
                }
            },
            
            hide() {
                if (UI.els.caddyBackdrop) {
                    UI.els.caddyBackdrop.classList.remove('active');
                }
                if (UI.els.caddySheet) {
                    UI.els.caddySheet.classList.remove('active');
                }
            },
            
            render() {
                if (!UI.els.suggestionList) return;
                
                const targetVal = UI.els.caddyTarget ? UI.els.caddyTarget.value.trim() : '';
                const target = targetVal ? Utils.saneYards(targetVal) : 0;
                
                // If showAll is true, show all clubs regardless of target
                // If showAll is false and no target, prompt for target
                if (!State.ui.showAll && !target) {
                    UI.els.suggestionList.innerHTML = '<div class="shot-list-empty">Enter a target distance</div>';
                    return;
                }
                
                const suggestions = Caddy.getSuggestions(
                    target || 999, // If showAll with no target, use high number to show everything
                    State.ui.caddyMode,
                    State.ui.showAll
                );
                
                UI.els.suggestionList.innerHTML = '';
                
                if (!suggestions.length) {
                    const empty = document.createElement('div');
                    empty.className = 'shot-list-empty';
                    empty.textContent = 'No clubs match';
                    UI.els.suggestionList.appendChild(empty);
                    return;
                }
                
                suggestions.forEach(sug => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    const info = document.createElement('div');
                    info.className = 'suggestion-info';
                    
                    const clubName = document.createElement('div');
                    clubName.className = 'suggestion-club';
                    clubName.textContent = `${sug.club} â€¢ ${sug.shotType}`;
                    
                    const meta = document.createElement('div');
                    meta.className = 'suggestion-meta';
                    
                    // Show diff as +/- to indicate over/under target
                    const diffText = target ? (sug.distance > target ? `+${sug.diff}y` : (sug.distance < target ? `-${sug.diff}y` : '0y')) : '';
                    meta.textContent = `${sug.carry}y carry â€¢ ${sug.total}y total${diffText ? ' â€¢ ' + diffText : ''}`;
                    
                    info.appendChild(clubName);
                    info.appendChild(meta);
                    
                    const btn = document.createElement('button');
                    btn.className = 'suggestion-btn';
                    btn.textContent = 'Select';
                    btn.addEventListener('click', () => {
                        Actions.addShot({ club: sug.club, shotType: sug.shotType });
                        this.close();
                    });
                    
                    item.appendChild(info);
                    item.appendChild(btn);
                    UI.els.suggestionList.appendChild(item);
                });
            }
        };
        
        // ============================================
        // BAG EDITOR UI
        // ============================================
        
        const BagEditorUI = {
            open() {
                // Close all other sheets first
                this.closeAllOtherSheets();
                
                // Show bag name in title and display line
                if (UI.els.bagTitle) {
                    const name = State.bag && State.bag.name ? State.bag.name : 'Bag Editor';
                    UI.els.bagTitle.textContent = name;
                }
                if (UI.els.bagNameDisplay) {
                    UI.els.bagNameDisplay.textContent = State.bag && State.bag.name ? 'ðŸŒï¸ ' + State.bag.name : '';
                }
                
                this.show();
                this.populateSelects();
                this.renderBagMatrix();
                this.loadCurrentSelection();
            },
            
            openManageClubs() {
                if (UI.els.manageClubsBackdrop) UI.els.manageClubsBackdrop.classList.add('active');
                if (UI.els.manageClubsSheet) UI.els.manageClubsSheet.classList.add('active');
                this.renderClubList();
                this.renderShotTypeList();
            },
            
            closeManageClubs() {
                if (UI.els.manageClubsBackdrop) UI.els.manageClubsBackdrop.classList.remove('active');
                if (UI.els.manageClubsSheet) UI.els.manageClubsSheet.classList.remove('active');
                // Refresh bag editor selects and matrix in case clubs changed
                this.populateSelects();
                this.renderBagMatrix();
            },
            
            close() {
                this.hide();
            },
            
            closeAllOtherSheets() {
                // Hide all other sheets/backdrops
                if (CaddyUI) CaddyUI.hide();
                if (CourseSetupUI) CourseSetupUI.hide();
                if (HolePickerUI) HolePickerUI.hide();
            },
            
            show() {
                if (UI.els.bagBackdrop) {
                    UI.els.bagBackdrop.classList.add('active');
                }
                if (UI.els.bagSheet) {
                    UI.els.bagSheet.classList.add('active');
                }
            },
            
            hide() {
                if (UI.els.bagBackdrop) {
                    UI.els.bagBackdrop.classList.remove('active');
                }
                if (UI.els.bagSheet) {
                    UI.els.bagSheet.classList.remove('active');
                }
            },
            
            populateSelects() {
                // Populate club select
                if (UI.els.bagClub) {
                    UI.els.bagClub.innerHTML = '';
                    State.bag.clubs.forEach(club => {
                        if (club === 'Club?') return;
                        const option = document.createElement('option');
                        option.value = club;
                        option.textContent = club;
                        UI.els.bagClub.appendChild(option);
                    });
                }
                
                // Populate shot type select
                if (UI.els.bagShotType) {
                    UI.els.bagShotType.innerHTML = '';
                    State.bag.shotTypes.forEach(type => {
                        if (type === 'Type?') return;
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        UI.els.bagShotType.appendChild(option);
                    });
                }
            },
            
            loadCurrentSelection() {
                const club = UI.els.bagClub ? UI.els.bagClub.value : null;
                const shotType = UI.els.bagShotType ? UI.els.bagShotType.value : null;
                
                if (!club || !shotType) return;
                
                const bagData = State.bag.data[club];
                if (bagData && bagData[shotType]) {
                    const distances = bagData[shotType];
                    if (UI.els.bagCarry) UI.els.bagCarry.value = distances.carry || '';
                    if (UI.els.bagTotal) UI.els.bagTotal.value = distances.total || '';
                } else {
                    if (UI.els.bagCarry) UI.els.bagCarry.value = '';
                    if (UI.els.bagTotal) UI.els.bagTotal.value = '';
                }
            },
            
            saveEntry() {
                const club = UI.els.bagClub ? UI.els.bagClub.value : null;
                const shotType = UI.els.bagShotType ? UI.els.bagShotType.value : null;
                const carry = UI.els.bagCarry ? Utils.saneYards(UI.els.bagCarry.value) : null;
                const total = UI.els.bagTotal ? Utils.saneYards(UI.els.bagTotal.value) : null;
                
                if (!club || !shotType) {
                    Utils.toast('Select club and shot type');
                    return;
                }
                
                // Save to State
                if (!State.bag.data[club]) {
                    State.bag.data[club] = {};
                }
                
                State.bag.data[club][shotType] = {
                    carry: carry || 0,
                    total: total || 0
                };
                
                // Save to localStorage
                State.saveBag();
                
                // Show immediate feedback
                Utils.toast('Saved to bag');
                
                // Clear input fields for next entry
                if (UI.els.bagCarry) UI.els.bagCarry.value = '';
                if (UI.els.bagTotal) UI.els.bagTotal.value = '';
                
                // Re-render the matrix to show the update
                this.renderBagMatrix();
            },
            
            renderClubList() {
                const container = UI.els.clubList;
                if (!container) return;
                const clubs = State.bag.clubs.filter(function(c) { return c !== 'Club?'; });
                if (clubs.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">No clubs added yet.</div>';
                    return;
                }
                container.innerHTML = '';
                const btnBase = 'padding:3px 7px; font-size:0.8rem; font-weight:700; border-radius:4px; cursor:pointer; border:1px solid var(--border); background:var(--bg-card-light); color:var(--text-primary);';
                const btnDel = 'padding:3px 8px; font-size:0.72rem; font-weight:700; border-radius:4px; border:1px solid rgba(230,69,69,0.4); background:rgba(230,69,69,0.1); color:var(--red); cursor:pointer;';
                clubs.forEach(function(club, idx) {
                    const row = document.createElement('div');
                    row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 4px 0;';
                    const label = document.createElement('span');
                    label.style.cssText = 'font-weight:700; font-size:0.9rem; flex:1;';
                    label.textContent = club;
                    const btns = document.createElement('div');
                    btns.style.cssText = 'display:flex; gap:4px;';
                    const up = document.createElement('button');
                    up.textContent = 'â†‘';
                    up.style.cssText = btnBase;
                    up.disabled = idx === 0;
                    up.addEventListener('click', function() { BagEditorUI.moveClub(club, -1); });
                    const dn = document.createElement('button');
                    dn.textContent = 'â†“';
                    dn.style.cssText = btnBase;
                    dn.disabled = idx === clubs.length - 1;
                    dn.addEventListener('click', function() { BagEditorUI.moveClub(club, 1); });
                    const del = document.createElement('button');
                    del.textContent = 'Delete';
                    del.style.cssText = btnDel;
                    del.addEventListener('click', function() { BagEditorUI.deleteClub(club); });
                    btns.appendChild(up);
                    btns.appendChild(dn);
                    btns.appendChild(del);
                    row.appendChild(label);
                    row.appendChild(btns);
                    container.appendChild(row);
                });
            },

            addClub() {
                const input = UI.els.newClubInput;
                if (!input) return;
                const name = input.value.trim();
                if (!name) { Utils.toast('Enter a club name'); return; }
                if (State.bag.clubs.indexOf(name) >= 0) { Utils.toast('Club already exists'); return; }
                State.bag.clubs.push(name);
                State.saveBag();
                input.value = '';
                this.populateSelects();
                this.renderClubList();
                Utils.toast('Club added: ' + name);
            },

            deleteClub(club) {
                const idx = State.bag.clubs.indexOf(club);
                if (idx < 0) return;
                // Two-tap confirmation via button state handled inline
                State.bag.clubs.splice(idx, 1);
                // Remove from data matrix too
                if (State.bag.data[club]) {
                    delete State.bag.data[club];
                }
                State.saveBag();
                this.populateSelects();
                this.renderClubList();
                this.renderBagMatrix();
                Utils.toast(club + ' deleted');
            },

            moveClub(club, dir) {
                const arr = State.bag.clubs;
                const idx = arr.indexOf(club);
                if (idx < 0) return;
                const newIdx = idx + dir;
                if (newIdx < 1 || newIdx >= arr.length) return;
                arr.splice(idx, 1);
                arr.splice(newIdx, 0, club);
                State.saveBag();
                this.populateSelects();
                this.renderClubList();
            },

            renderShotTypeList() {
                const container = UI.els.shotTypeList;
                if (!container) return;
                const types = State.bag.shotTypes.filter(function(t) { return t !== 'Type?'; });
                if (types.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">No shot types added yet.</div>';
                    return;
                }
                container.innerHTML = '';
                const btnBase = 'padding:3px 7px; font-size:0.8rem; font-weight:700; border-radius:4px; cursor:pointer; border:1px solid var(--border); background:var(--bg-card-light); color:var(--text-primary);';
                const btnDel = 'padding:3px 8px; font-size:0.72rem; font-weight:700; border-radius:4px; border:1px solid rgba(230,69,69,0.4); background:rgba(230,69,69,0.1); color:var(--red); cursor:pointer;';
                types.forEach(function(type, idx) {
                    const row = document.createElement('div');
                    row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 4px 0;';
                    const label = document.createElement('span');
                    label.style.cssText = 'font-weight:700; font-size:0.9rem; flex:1;';
                    label.textContent = type;
                    const btns = document.createElement('div');
                    btns.style.cssText = 'display:flex; gap:4px;';
                    const up = document.createElement('button');
                    up.textContent = 'â†‘';
                    up.style.cssText = btnBase;
                    up.disabled = idx === 0;
                    up.addEventListener('click', function() { BagEditorUI.moveShotType(type, -1); });
                    const dn = document.createElement('button');
                    dn.textContent = 'â†“';
                    dn.style.cssText = btnBase;
                    dn.disabled = idx === types.length - 1;
                    dn.addEventListener('click', function() { BagEditorUI.moveShotType(type, 1); });
                    const del = document.createElement('button');
                    del.textContent = 'Delete';
                    del.style.cssText = btnDel;
                    del.addEventListener('click', function() { BagEditorUI.deleteShotType(type); });
                    btns.appendChild(up);
                    btns.appendChild(dn);
                    btns.appendChild(del);
                    row.appendChild(label);
                    row.appendChild(btns);
                    container.appendChild(row);
                });
            },

            addShotType() {
                const input = UI.els.newShotTypeInput;
                if (!input) return;
                const name = input.value.trim();
                if (!name) { Utils.toast('Enter a shot type name'); return; }
                if (State.bag.shotTypes.indexOf(name) >= 0) { Utils.toast('Shot type already exists'); return; }
                State.bag.shotTypes.push(name);
                State.saveBag();
                input.value = '';
                this.populateSelects();
                this.renderShotTypeList();
                Utils.toast('Shot type added: ' + name);
            },

            deleteShotType(type) {
                const idx = State.bag.shotTypes.indexOf(type);
                if (idx < 0) return;
                State.bag.shotTypes.splice(idx, 1);
                // Remove this shot type from all clubs in data matrix
                Object.keys(State.bag.data).forEach(function(club) {
                    if (State.bag.data[club][type]) {
                        delete State.bag.data[club][type];
                    }
                });
                State.saveBag();
                this.populateSelects();
                this.renderShotTypeList();
                this.renderBagMatrix();
                Utils.toast(type + ' deleted');
            },

            moveShotType(type, dir) {
                const arr = State.bag.shotTypes;
                const idx = arr.indexOf(type);
                if (idx < 0) return;
                const newIdx = idx + dir;
                if (newIdx < 1 || newIdx >= arr.length) return; // don't move past 'Type?' sentinel
                arr.splice(idx, 1);
                arr.splice(newIdx, 0, type);
                State.saveBag();
                this.populateSelects();
                this.renderShotTypeList();
            },

            renderBagMatrix() {
                if (!UI.els.bagMatrix) return;
                
                UI.els.bagMatrix.innerHTML = '';
                
                const bagData = State.bag.data;
                const clubs = Object.keys(bagData).sort();
                
                if (!clubs.length) {
                    UI.els.bagMatrix.innerHTML = '<div style="color: var(--text-muted); padding: var(--space-2);">No clubs configured</div>';
                    return;
                }
                
                clubs.forEach(club => {
                    const shotTypes = bagData[club];
                    const types = Object.keys(shotTypes);
                    
                    types.forEach(type => {
                        const distances = shotTypes[type];
                        const row = document.createElement('div');
                        row.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: var(--space-2) 0; border-bottom: 1px solid rgba(255,255,255,0.04);';
                        
                        const label = document.createElement('div');
                        label.style.fontWeight = '700';
                        label.textContent = `${club} â€¢ ${type}`;
                        
                        const rightSide = document.createElement('div');
                        rightSide.style.cssText = 'display: flex; align-items: center; gap: var(--space-2);';
                        
                        const values = document.createElement('div');
                        values.style.cssText = 'font-family: var(--font-mono); color: var(--text-muted);';
                        values.textContent = `${distances.carry}y / ${distances.total}y`;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Ã—';
                        deleteBtn.style.cssText = 'background: rgba(230,69,69,0.15); border: 1px solid rgba(230,69,69,0.3); color: var(--red); border-radius: 6px; width: 28px; height: 28px; font-size: 1.25rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;';
                        deleteBtn.title = 'Delete this club/shot combination';
                        deleteBtn.addEventListener('click', () => {
                            if (confirm(`Delete ${club} ${type}?`)) {
                                delete State.bag.data[club][type];
                                // If no more shot types for this club, remove the club entirely
                                if (Object.keys(State.bag.data[club]).length === 0) {
                                    delete State.bag.data[club];
                                }
                                State.saveBag();
                                this.renderBagMatrix();
                                Utils.toast('Deleted');
                            }
                        });
                        
                        rightSide.appendChild(values);
                        rightSide.appendChild(deleteBtn);
                        
                        row.appendChild(label);
                        row.appendChild(rightSide);
                        UI.els.bagMatrix.appendChild(row);
                    });
                });
            }
        };
        
        // ============================================
        // COURSE SETUP UI
        // ============================================
        
        const CourseSetupUI = {
            editingCourseId: null,
            
            open() {
                this.editingCourseId = State.currentCourseId;
                this.hidePicker();
                this.show();
                this.loadCourseData();
                this.renderHoles();
            },
            
            close() {
                this.hidePicker();
                this.hide();
            },
            
            show() {
                if (UI.els.courseBackdrop) UI.els.courseBackdrop.classList.add('active');
                if (UI.els.courseSheet) UI.els.courseSheet.classList.add('active');
            },
            
            hide() {
                if (UI.els.courseBackdrop) UI.els.courseBackdrop.classList.remove('active');
                if (UI.els.courseSheet) UI.els.courseSheet.classList.remove('active');
            },
            
            loadCourseData() {
                const course = Library.getCourse(this.editingCourseId);
                if (UI.els.courseName) {
                    UI.els.courseName.value = course ? (course.name || '') : (State.courseName || '');
                }
            },
            
            togglePicker() {
                const list = UI.els.coursePickerList;
                if (!list) return;
                if (list.style.display === 'none' || list.style.display === '') {
                    this.showPicker();
                } else {
                    this.hidePicker();
                }
            },
            
            showPicker() {
                const list = UI.els.coursePickerList;
                if (!list) return;
                list.innerHTML = '';
                const self = this;
                Library.getCourses().forEach(function(course) {
                    const item = document.createElement('div');
                    const isActive = course.id === self.editingCourseId;
                    item.style.cssText = 'padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 700;' +
                        (isActive ? 'background: rgba(74,222,128,0.15); color: var(--green-400);' : 'color: var(--text-primary);');
                    item.textContent = course.name + (isActive ? ' âœ“' : '');
                    item.addEventListener('click', function() {
                        self.selectCourse(course.id);
                    });
                    list.appendChild(item);
                });
                list.style.display = 'flex';
            },
            
            hidePicker() {
                const list = UI.els.coursePickerList;
                if (list) list.style.display = 'none';
            },
            
            selectCourse(courseId) {
                const course = Library.getCourse(courseId);
                if (!course) return;
                this.editingCourseId = courseId;
                // Load into State
                State.currentCourseId = courseId;
                State.courseName = course.name || '';
                State.course = course;
                State.initHoles();
                if (course.holes) {
                    course.holes.forEach(function(ch, idx) {
                        if (State.holes[idx]) {
                            State.holes[idx].par = ch.par || 0;
                            State.holes[idx].yards = ch.yards || 0;
                            State.holes[idx].hcp = ch.hcp || 0;
                            if (ch.teeGPS) State.holes[idx].tee = ch.teeGPS;
                            if (ch.flagGPS) State.holes[idx].flag = ch.flagGPS;
                        }
                    });
                }
                State.save();
                this.hidePicker();
                this.loadCourseData();
                this.renderHoles();
                Utils.toast('Editing: ' + course.name);
            },
            
            renderHoles() {
                if (!UI.els.courseHoles) return;
                
                UI.els.courseHoles.innerHTML = '';
                
                State.holes.forEach((hole, idx) => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-3);';
                    
                    const header = document.createElement('div');
                    header.style.cssText = 'font-weight: 900; margin-bottom: var(--space-2); font-size: 0.875rem;';
                    header.textContent = `Hole ${idx + 1}`;
                    
                    const inputs = document.createElement('div');
                    inputs.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-2);';
                    
                    const parInput = this.createInput('Par', hole.par || '', `par-${idx}`);
                    const yardsInput = this.createInput('Yards', hole.yards || '', `yards-${idx}`);
                    const hcpInput = this.createInput('HCP', hole.hcp || '', `hcp-${idx}`);
                    
                    inputs.appendChild(parInput);
                    inputs.appendChild(yardsInput);
                    inputs.appendChild(hcpInput);
                    
                    card.appendChild(header);
                    card.appendChild(inputs);
                    UI.els.courseHoles.appendChild(card);
                });
            },
            
            createInput(label, value, id) {
                const wrapper = document.createElement('div');
                
                const labelEl = document.createElement('label');
                labelEl.style.cssText = 'display: block; font-size: 0.625rem; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase;';
                labelEl.textContent = label;
                labelEl.setAttribute('for', id);
                
                const input = document.createElement('input');
                input.id = id;
                input.type = 'text';
                input.inputMode = 'numeric';
                input.pattern = '[0-9]*';
                input.value = value;
                input.style.cssText = 'width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: var(--space-2); color: var(--text-primary); font-size: 1rem; font-weight: 700; font-family: var(--font-mono);';
                
                wrapper.appendChild(labelEl);
                wrapper.appendChild(input);
                return wrapper;
            },
            
            saveCourse() {
                const courseId = this.editingCourseId || State.currentCourseId;
                const courseName = UI.els.courseName ? UI.els.courseName.value.trim() : '';
                const holesData = [];
                
                State.holes.forEach((hole, idx) => {
                    const parInput = Utils.$(`par-${idx}`);
                    const yardsInput = Utils.$(`yards-${idx}`);
                    const hcpInput = Utils.$(`hcp-${idx}`);
                    
                    const par = parInput ? Utils.clampInt(parInput.value, 0, 9) : hole.par;
                    const yards = yardsInput ? Utils.clampInt(yardsInput.value, 0, 999) : hole.yards;
                    const hcp = hcpInput ? Utils.clampInt(hcpInput.value, 0, 18) : hole.hcp;
                    
                    State.holes[idx].par = par || 0;
                    State.holes[idx].yards = yards || 0;
                    State.holes[idx].hcp = hcp || 0;
                    
                    holesData.push({
                        hole: idx + 1,
                        par: par || 0,
                        yards: yards || 0,
                        hcp: hcp || 0
                    });
                });
                
                // Save to library, preserving GPS data
                const existingCourse = Library.getCourse(courseId);
                if (existingCourse) {
                    if (courseName) existingCourse.name = courseName;
                    holesData.forEach(function(hd, idx) {
                        if (existingCourse.holes && existingCourse.holes[idx]) {
                            existingCourse.holes[idx].par = hd.par;
                            existingCourse.holes[idx].yards = hd.yards;
                            existingCourse.holes[idx].hcp = hd.hcp;
                        }
                    });
                    Library.saveCourse(existingCourse);
                }
                
                // If editing the active course, sync State too
                if (courseId === State.currentCourseId) {
                    State.saveCourseData(courseName || State.courseName, holesData);
                }
                
                State.save();
                UI.render();
                Utils.toast('Course saved');
            }
        };
        
        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================
        
        const ExportData = {
            generateCSV() {
                const rows = [];
                
                // Header
                rows.push([
                    'Hole',
                    'Shot Number',
                    'Club',
                    'Shot Type',
                    'Target Distance',
                    'Actual Distance',
                    'Carry (Bag)',
                    'Total (Bag)',
                    'Penalty',
                    'Timestamp'
                ].join(','));
                
                // Data rows
                State.holes.forEach(hole => {
                    hole.shots.forEach((shot, shotIdx) => {
                        const bagData = State.bag.data[shot.club];
                        let bagCarry = '';
                        let bagTotal = '';
                        
                        if (bagData && bagData[shot.shotType]) {
                            bagCarry = bagData[shot.shotType].carry || '';
                            bagTotal = bagData[shot.shotType].total || '';
                        }
                        
                        rows.push([
                            hole.hole,
                            shotIdx + 1,
                            shot.club || '',
                            shot.shotType || '',
                            shot.distance || 0,
                            shot.distance || 0,
                            bagCarry,
                            bagTotal,
                            shot.penalty ? 'YES' : 'NO',
                            shot.timestamp || ''
                        ].join(','));
                    });
                });
                
                return rows.join('\n');
            },
            
            downloadCSV() {
                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const date = new Date(State.round.startedAt);
                const filename = `shot-tracker-${date.toISOString().split('T')[0]}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Utils.toast('CSV exported');
            },
            
            generateReport() {
                const lines = [];
                
                lines.push('SHOT TRACKER REPORT');
                lines.push('===================');
                lines.push('');
                lines.push(`Course: ${State.courseName || 'Unknown'}`);
                lines.push(`Date: ${new Date(State.round.startedAt).toLocaleString()}`);
                lines.push(`Total Shots: ${State.totalShots()}`);
                lines.push('');
                lines.push('HOLE-BY-HOLE BREAKDOWN');
                lines.push('----------------------');
                
                State.holes.forEach(hole => {
                    if (hole.shots.length === 0) return;
                    
                    lines.push('');
                    lines.push(`Hole ${hole.hole} - Par ${hole.par || '?'} - ${hole.yards || '?'} yards`);
                    lines.push(`Shots: ${hole.shots.length} - Fairway: ${hole.fwy ? 'Yes' : 'No'} - GIR: ${hole.gir ? 'Yes' : 'No'}`);
                    
                    hole.shots.forEach((shot, idx) => {
                        const bagData = State.bag.data[shot.club];
                        let bagInfo = '';
                        
                        if (bagData && bagData[shot.shotType]) {
                            const dist = bagData[shot.shotType];
                            bagInfo = ` (Bag: ${dist.carry}y/${dist.total}y)`;
                        }
                        
                        lines.push(`  ${idx + 1}. ${shot.club} ${shot.shotType} - ${shot.distance}y${bagInfo}${shot.penalty ? ' [PENALTY]' : ''}`);
                    });
                });
                
                return lines.join('\n');
            },
            
            showReport() {
                const report = this.generateReport();
                
                // Create modal for report
                const backdrop = document.createElement('div');
                backdrop.className = 'backdrop active';
                backdrop.style.zIndex = '300';
                
                const modal = document.createElement('div');
                modal.className = 'sheet active';
                modal.style.cssText = 'z-index: 301; max-height: 90vh;';
                
                const header = document.createElement('div');
                header.className = 'sheet-header';
                
                const title = document.createElement('h3');
                title.className = 'sheet-title';
                title.textContent = 'Round Report';
                
                const actions = document.createElement('div');
                actions.className = 'sheet-actions';
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'btn btn-sm btn-secondary';
                closeBtn.textContent = 'Close';
                closeBtn.onclick = () => {
                    backdrop.remove();
                    modal.remove();
                };
                
                actions.appendChild(closeBtn);
                header.appendChild(title);
                header.appendChild(actions);
                
                const content = document.createElement('pre');
                content.style.cssText = 'white-space: pre-wrap; font-family: var(--font-mono); font-size: 0.75rem; line-height: 1.6; color: var(--text-primary); overflow-x: auto; margin-top: var(--space-4);';
                content.textContent = report;
                
                modal.appendChild(header);
                modal.appendChild(content);
                
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                
                backdrop.onclick = () => {
                    backdrop.remove();
                    modal.remove();
                };
            }
        };
        
        // ============================================
        // IMPORT / EXPORT (v40.4)
        // ============================================
        
        const ImportExport = {
            
            // --- EXPORT ---
            
            exportBags() {
                try {
                    const bags = Library.getBags();
                    if (!bags || bags.length === 0) {
                        Utils.toast('No bags to export');
                        return;
                    }
                    const json = JSON.stringify({ type: 'shotTrackerBags', version: VERSION, bags: bags }, null, 2);
                    this._download(json, 'shot-tracker-bags.json');
                    Utils.toast('Bags exported!');
                } catch (e) {
                    console.error('Export bags error:', e);
                    Utils.toast('Export failed');
                }
            },
            
            exportCourses() {
                try {
                    const courses = Library.getCourses();
                    if (!courses || courses.length === 0) {
                        Utils.toast('No courses to export');
                        return;
                    }
                    const json = JSON.stringify({ type: 'shotTrackerCourses', version: VERSION, courses: courses }, null, 2);
                    this._download(json, 'shot-tracker-courses.json');
                    Utils.toast('Courses exported!');
                } catch (e) {
                    console.error('Export courses error:', e);
                    Utils.toast('Export failed');
                }
            },
            
            _download(json, filename) {
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            // --- IMPORT ---
            
            importBags() {
                this._pickFile(function(json) {
                    try {
                        const data = JSON.parse(json);
                        if (!data || !data.bags || !Array.isArray(data.bags)) {
                            Utils.toast('Invalid bag file');
                            return;
                        }
                        let added = 0;
                        const existing = Library.getBags();
                        data.bags.forEach(function(bag) {
                            if (!bag.id || !bag.name) return;
                            const dupe = existing.find(function(b) { return b.id === bag.id; });
                            if (!dupe) {
                                Library.saveBag(bag);
                                added++;
                            }
                        });
                        Utils.toast(added + ' bag' + (added !== 1 ? 's' : '') + ' imported');
                        LibraryUI.render();
                    } catch (e) {
                        console.error('Import bags error:', e);
                        Utils.toast('Import failed - invalid file');
                    }
                });
            },
            
            importCourses() {
                this._pickFile(function(json) {
                    try {
                        const data = JSON.parse(json);
                        if (!data || !data.courses || !Array.isArray(data.courses)) {
                            Utils.toast('Invalid course file');
                            return;
                        }
                        let added = 0;
                        const existing = Library.getCourses();
                        data.courses.forEach(function(course) {
                            if (!course.id || !course.name) return;
                            const dupe = existing.find(function(c) { return c.id === course.id; });
                            if (!dupe) {
                                Library.saveCourse(course);
                                added++;
                            }
                        });
                        Utils.toast(added + ' course' + (added !== 1 ? 's' : '') + ' imported');
                        LibraryUI.render();
                    } catch (e) {
                        console.error('Import courses error:', e);
                        Utils.toast('Import failed - invalid file');
                    }
                });
            },
            
            _pickFile(callback) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = function() {
                    const file = input.files && input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        callback(e.target.result);
                    };
                    reader.onerror = function() {
                        Utils.toast('Could not read file');
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        };
        
        // ============================================
        // LIBRARY ACTIONS (v40.5)
        // ============================================
        
        const LibraryActions = {
            
            // --- BAG ACTIONS ---
            
            activateBag(id) {
                const bag = Library.getBag(id);
                if (!bag) return;
                State.currentBagId = id;
                State.bag = bag;
                State.save();
                LibraryUI.render();
                Utils.toast('Bag activated: ' + bag.name);
            },
            
            copyBag(id) {
                const bag = Library.getBag(id);
                if (!bag) return;
                const copy = JSON.parse(JSON.stringify(bag));
                copy.id = Utils.generateId('bag');
                copy.name = bag.name + ' - Copy';
                copy.created = Utils.nowISO();
                Library.saveBag(copy);
                LibraryUI.render();
                Utils.toast('Bag copied: ' + copy.name);
            },
            
            renameBag(id) {
                const bag = Library.getBag(id);
                if (!bag) return;
                // Show inline rename input
                const inputId = 'rename-input-' + id;
                const existing = document.getElementById(inputId);
                if (existing) { existing.focus(); return; }
                const row = document.getElementById('bag-row-' + id);
                if (!row) return;
                const div = document.createElement('div');
                div.style.cssText = 'display:flex;gap:6px;margin-top:6px;';
                div.innerHTML = '<input id="' + inputId + '" type="text" value="' + Utils.escHtml(bag.name) + '" style="flex:1;padding:4px 8px;font-size:0.85rem;border-radius:4px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);"><button style="padding:4px 10px;font-size:0.75rem;font-weight:700;border-radius:4px;border:1px solid var(--green-500);background:var(--green-700);color:white;" onclick="LibraryActions.confirmRenameBag(\'' + id + '\')">Save</button>';
                row.appendChild(div);
                document.getElementById(inputId).focus();
            },
            
            confirmRenameBag(id) {
                const bag = Library.getBag(id);
                if (!bag) return;
                const input = document.getElementById('rename-input-' + id);
                if (!input) return;
                const newName = input.value.trim();
                if (!newName) { Utils.toast('Name cannot be empty'); return; }
                bag.name = newName;
                Library.saveBag(bag);
                LibraryUI.render();
                Utils.toast('Renamed');
            },
            
            deleteBag(id) {
                if (id === State.currentBagId) {
                    Utils.toast('Cannot delete active bag');
                    return;
                }
                const btn = document.getElementById('del-bag-' + id);
                if (!btn) return;
                if (btn.dataset.confirm === '1') {
                    const bag = Library.getBag(id);
                    if (!bag) return;
                    Library.deleteBag(id);
                    LibraryUI.render();
                    Utils.toast('Deleted');
                } else {
                    btn.dataset.confirm = '1';
                    btn.textContent = 'Sure?';
                    btn.style.borderColor = '#e64545';
                    btn.style.color = '#e64545';
                    setTimeout(function() {
                        if (btn && btn.dataset.confirm === '1') {
                            btn.dataset.confirm = '';
                            btn.textContent = 'Delete';
                            btn.style.borderColor = '';
                            btn.style.color = '';
                        }
                    }, 3000);
                }
            },
            
            exportBag(id) {
                const bag = Library.getBag(id);
                if (!bag) return;
                try {
                    const json = JSON.stringify({ type: 'shotTrackerBags', version: VERSION, bags: [bag] }, null, 2);
                    const safeName = bag.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    ImportExport._download(json, 'bag-' + safeName + '.json');
                    Utils.toast('Bag exported');
                } catch (e) {
                    console.error('Export bag error:', e);
                    Utils.toast('Export failed');
                }
            },
            
            // --- COURSE ACTIONS ---
            
            activateCourse(id) {
                const course = Library.getCourse(id);
                if (!course) return;
                State.currentCourseId = id;
                State.course = course;
                State.save();
                LibraryUI.render();
                Utils.toast('Course activated: ' + course.name);
            },
            
            copyCourse(id) {
                const course = Library.getCourse(id);
                if (!course) return;
                const copy = JSON.parse(JSON.stringify(course));
                copy.id = Utils.generateId('course');
                copy.name = course.name + ' - Copy';
                copy.created = Utils.nowISO();
                Library.saveCourse(copy);
                LibraryUI.render();
                Utils.toast('Course copied: ' + copy.name);
            },
            
            renameCourse(id) {
                const course = Library.getCourse(id);
                if (!course) return;
                const inputId = 'rename-input-' + id;
                const existing = document.getElementById(inputId);
                if (existing) { existing.focus(); return; }
                const row = document.getElementById('course-row-' + id);
                if (!row) return;
                const div = document.createElement('div');
                div.style.cssText = 'display:flex;gap:6px;margin-top:6px;';
                div.innerHTML = '<input id="' + inputId + '" type="text" value="' + Utils.escHtml(course.name) + '" style="flex:1;padding:4px 8px;font-size:0.85rem;border-radius:4px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);"><button style="padding:4px 10px;font-size:0.75rem;font-weight:700;border-radius:4px;border:1px solid var(--green-500);background:var(--green-700);color:white;" onclick="LibraryActions.confirmRenameCourse(\'' + id + '\')">Save</button>';
                row.appendChild(div);
                document.getElementById(inputId).focus();
            },
            
            confirmRenameCourse(id) {
                const course = Library.getCourse(id);
                if (!course) return;
                const input = document.getElementById('rename-input-' + id);
                if (!input) return;
                const newName = input.value.trim();
                if (!newName) { Utils.toast('Name cannot be empty'); return; }
                course.name = newName;
                Library.saveCourse(course);
                LibraryUI.render();
                Utils.toast('Renamed');
            },
            
            deleteCourse(id) {
                if (id === State.currentCourseId) {
                    Utils.toast('Cannot delete active course');
                    return;
                }
                const btn = document.getElementById('del-course-' + id);
                if (!btn) return;
                if (btn.dataset.confirm === '1') {
                    const course = Library.getCourse(id);
                    if (!course) return;
                    Library.deleteCourse(id);
                    LibraryUI.render();
                    Utils.toast('Deleted');
                } else {
                    btn.dataset.confirm = '1';
                    btn.textContent = 'Sure?';
                    btn.style.borderColor = '#e64545';
                    btn.style.color = '#e64545';
                    setTimeout(function() {
                        if (btn && btn.dataset.confirm === '1') {
                            btn.dataset.confirm = '';
                            btn.textContent = 'Delete';
                            btn.style.borderColor = '';
                            btn.style.color = '';
                        }
                    }, 3000);
                }
            },
            
            exportCourse(id) {
                const course = Library.getCourse(id);
                if (!course) return;
                try {
                    const json = JSON.stringify({ type: 'shotTrackerCourses', version: VERSION, courses: [course] }, null, 2);
                    const safeName = course.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    ImportExport._download(json, 'course-' + safeName + '.json');
                    Utils.toast('Course exported');
                } catch (e) {
                    console.error('Export course error:', e);
                    Utils.toast('Export failed');
                }
            }
        };
        
                // ============================================
        // LIBRARY UI (v40.3 - View Only)
        // ============================================
        
        const LibraryUI = {
            open() {
                this.render();
                const backdrop = Utils.$('libraryBackdrop');
                const sheet = Utils.$('librarySheet');
                if (backdrop) backdrop.classList.add('active');
                if (sheet) sheet.classList.add('active');
            },
            
            close() {
                const backdrop = Utils.$('libraryBackdrop');
                const sheet = Utils.$('librarySheet');
                if (backdrop) backdrop.classList.remove('active');
                if (sheet) sheet.classList.remove('active');
            },
            
            render() {
                this.renderBags();
                this.renderCourses();
            },
            
            renderBags() {
                const container = Utils.$('bagLibraryList');
                if (!container) return;
                
                const bags = Library.getBags();
                const activeBagId = State.currentBagId;
                
                if (bags.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No bags in library.</p>';
                    return;
                }
                
                const btnStyle = 'padding: 4px 8px; font-size: 0.72rem; font-weight: 700; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card-light); color: var(--text-primary); cursor: pointer;';
                const btnGreenStyle = 'padding: 4px 8px; font-size: 0.72rem; font-weight: 700; border-radius: 4px; border: 1px solid var(--green-500); background: var(--green-700); color: white; cursor: pointer;';
                
                container.innerHTML = bags.map(bag => {
                    const isActive = bag.id === activeBagId;
                    const clubCount = bag.clubs ? bag.clubs.length : 0;
                    const dateStr = Utils.formatShortDate(bag.created);
                    const id = Utils.escHtml(bag.id);
                    return '<div id="bag-row-' + id + '" style="padding: var(--space-3); background: var(--bg-card-light); border-radius: var(--radius-md); border: 1px solid ' + (isActive ? 'var(--green-500)' : 'var(--border)') + '; margin-bottom: var(--space-1);">' +
                        '<div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 2px;">' + Utils.escHtml(bag.name) + (isActive ? ' <span style="color: var(--green-400); font-size: 0.75rem;">âœ“ Active</span>' : '') + '</div>' +
                        '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: var(--space-2);">' + clubCount + ' clubs' + (dateStr ? ' Â· Created: ' + dateStr : '') + '</div>' +
                        '<div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">' +
                            '<button style="' + (isActive ? btnGreenStyle : btnStyle) + '" onclick="LibraryActions.activateBag(\'' + id + '\')">' + (isActive ? 'âœ“ Active' : 'Activate') + '</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.copyBag(\'' + id + '\')">Copy</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.renameBag(\'' + id + '\')">Rename</button>' +
                            '<button id="del-bag-' + id + '" style="' + btnStyle + '" onclick="LibraryActions.deleteBag(\'' + id + '\')">Delete</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.exportBag(\'' + id + '\')">Export</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            },
            
            renderCourses() {
                const container = Utils.$('courseLibraryList');
                if (!container) return;
                
                const courses = Library.getCourses();
                const activeCourseId = State.currentCourseId;
                
                if (courses.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.875rem;">No courses in library.</p>';
                    return;
                }
                
                const btnStyle = 'padding: 4px 8px; font-size: 0.72rem; font-weight: 700; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card-light); color: var(--text-primary); cursor: pointer;';
                const btnGreenStyle = 'padding: 4px 8px; font-size: 0.72rem; font-weight: 700; border-radius: 4px; border: 1px solid var(--green-500); background: var(--green-700); color: white; cursor: pointer;';
                
                container.innerHTML = courses.map(course => {
                    const isActive = course.id === activeCourseId;
                    const holes = course.holes || [];
                    const teeCount = holes.filter(h => h.teeGPS).length;
                    const flagCount = holes.filter(h => h.flagGPS).length;
                    const dateStr = Utils.formatShortDate(course.created);
                    const id = Utils.escHtml(course.id);
                    return '<div id="course-row-' + id + '" style="padding: var(--space-3); background: var(--bg-card-light); border-radius: var(--radius-md); border: 1px solid ' + (isActive ? 'var(--green-500)' : 'var(--border)') + '; margin-bottom: var(--space-1);">' +
                        '<div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 2px;">' + Utils.escHtml(course.name) + (isActive ? ' <span style="color: var(--green-400); font-size: 0.75rem;">âœ“ Active</span>' : '') + '</div>' +
                        '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: var(--space-2);">' + teeCount + ' tee Â· ' + flagCount + ' flag GPS' + (dateStr ? ' Â· Created: ' + dateStr : '') + '</div>' +
                        '<div style="display: flex; gap: var(--space-1); flex-wrap: wrap;">' +
                            '<button style="' + (isActive ? btnGreenStyle : btnStyle) + '" onclick="LibraryActions.activateCourse(\'' + id + '\')">' + (isActive ? 'âœ“ Active' : 'Activate') + '</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.copyCourse(\'' + id + '\')">Copy</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.renameCourse(\'' + id + '\')">Rename</button>' +
                            '<button id="del-course-' + id + '" style="' + btnStyle + '" onclick="LibraryActions.deleteCourse(\'' + id + '\')">Delete</button>' +
                            '<button style="' + btnStyle + '" onclick="LibraryActions.exportCourse(\'' + id + '\')">Export</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }
        };
        
        // ============================================
        // HOLE PICKER UI
        // ============================================
        
        const HolePickerUI = {
            init() {
                // Intentionally empty â€” grid built on open() so data is fresh
            },
            
            renderGrid() {
                if (!UI.els.holeGrid) return;
                UI.els.holeGrid.innerHTML = '';
                
                for (let i = 0; i < 18; i++) {
                    const hole = State.holes[i];
                    const isActive = i === State.holeIndex;
                    
                    const btn = document.createElement('button');
                    btn.className = 'hole-picker-btn';
                    btn.type = 'button';
                    if (isActive) {
                        btn.style.borderColor = 'var(--green-400)';
                        btn.style.background = 'rgba(74,222,128,0.1)';
                    }
                    
                    const num = document.createElement('div');
                    num.className = 'hole-picker-num';
                    num.textContent = String(i + 1);
                    btn.appendChild(num);
                    
                    const par = hole && hole.par ? hole.par : null;
                    const yards = hole && hole.yards ? hole.yards : null;
                    const hcp = hole && hole.hcp ? hole.hcp : null;
                    
                    if (par) {
                        const parEl = document.createElement('div');
                        parEl.className = 'hole-picker-par';
                        parEl.textContent = 'Par ' + par;
                        btn.appendChild(parEl);
                    }
                    
                    if (yards || hcp) {
                        const infoEl = document.createElement('div');
                        infoEl.className = 'hole-picker-info';
                        const parts = [];
                        if (yards) parts.push(yards + 'y');
                        if (hcp) parts.push('HCP ' + hcp);
                        infoEl.textContent = parts.join(' Â· ');
                        btn.appendChild(infoEl);
                    }
                    
                    btn.addEventListener('click', (function(idx) {
                        return function() {
                            Actions.gotoHole(idx);
                            HolePickerUI.close();
                        };
                    })(i));
                    
                    UI.els.holeGrid.appendChild(btn);
                }
            },
            
            open() {
                this.renderGrid();
                this.show();
            },
            
            close() {
                this.hide();
            },
            
            show() {
                if (UI.els.holeBackdrop) {
                    UI.els.holeBackdrop.classList.add('active');
                }
                if (UI.els.holeSheet) {
                    UI.els.holeSheet.classList.add('active');
                }
            },
            
            hide() {
                if (UI.els.holeBackdrop) {
                    UI.els.holeBackdrop.classList.remove('active');
                }
                if (UI.els.holeSheet) {
                    UI.els.holeSheet.classList.remove('active');
                }
            }
        };
        
        // ============================================
        // EVENT BINDING
        // ============================================
        
        // ============================================
        // ROUND SETUP UI
        // ============================================
        
        const RoundSetupUI = {
            confirmed: false,
            
            open() {
                this.confirmed = false;
                this.populateSelects();
                this.resetStartButton();
                if (UI.els.roundSetupBackdrop) UI.els.roundSetupBackdrop.classList.add('active');
                if (UI.els.roundSetupSheet) UI.els.roundSetupSheet.classList.add('active');
            },
            
            close() {
                this.confirmed = false;
                this.resetStartButton();
                if (UI.els.roundSetupBackdrop) UI.els.roundSetupBackdrop.classList.remove('active');
                if (UI.els.roundSetupSheet) UI.els.roundSetupSheet.classList.remove('active');
            },
            
            populateSelects() {
                const bagSel = UI.els.roundBagSelect;
                if (bagSel) {
                    bagSel.innerHTML = '';
                    Library.getBags().forEach(function(bag) {
                        const opt = document.createElement('option');
                        opt.value = bag.id;
                        opt.textContent = bag.name;
                        if (bag.id === State.currentBagId) opt.selected = true;
                        bagSel.appendChild(opt);
                    });
                }
                const courseSel = UI.els.roundCourseSelect;
                if (courseSel) {
                    courseSel.innerHTML = '';
                    Library.getCourses().forEach(function(course) {
                        const opt = document.createElement('option');
                        opt.value = course.id;
                        opt.textContent = course.name;
                        if (course.id === State.currentCourseId) opt.selected = true;
                        courseSel.appendChild(opt);
                    });
                }
            },
            
            resetStartButton() {
                const btn = UI.els.btnStartRound;
                if (!btn) return;
                btn.textContent = 'Start Round';
                btn.style.background = '';
                btn.style.borderColor = '';
                this.confirmed = false;
            },
            
            startRound() {
                const bagSel = UI.els.roundBagSelect;
                const courseSel = UI.els.roundCourseSelect;
                const bagId = bagSel ? bagSel.value : null;
                const courseId = courseSel ? courseSel.value : null;
                if (!bagId || !courseId) {
                    Utils.toast('Select a bag and course');
                    return;
                }
                
                // Check for existing shot data
                const totalShots = State.totalShots();
                if (totalShots > 0 && !this.confirmed) {
                    const btn = UI.els.btnStartRound;
                    if (btn) {
                        btn.textContent = 'Clear ' + totalShots + ' shots & start?';
                        btn.style.background = 'rgba(230,69,69,0.2)';
                        btn.style.borderColor = 'rgba(230,69,69,0.6)';
                    }
                    this.confirmed = true;
                    const self = this;
                    setTimeout(function() {
                        if (self.confirmed) self.resetStartButton();
                    }, 4000);
                    return;
                }
                
                const bag = Library.getBag(bagId);
                const course = Library.getCourse(courseId);
                if (!bag || !course) {
                    Utils.toast('Bag or course not found');
                    return;
                }
                
                State.currentBagId = bagId;
                State.currentCourseId = courseId;
                
                State.bag = {
                    name: bag.name || '',
                    clubs: bag.clubs.slice(),
                    shotTypes: bag.shotTypes.slice(),
                    data: JSON.parse(JSON.stringify(bag.data))
                };
                
                State.initHoles();
                
                if (course.holes) {
                    course.holes.forEach(function(ch, idx) {
                        if (State.holes[idx]) {
                            State.holes[idx].par = ch.par || 0;
                            State.holes[idx].yards = ch.yards || 0;
                            State.holes[idx].hcp = ch.hcp || 0;
                            if (ch.teeGPS) State.holes[idx].tee = ch.teeGPS;
                            if (ch.flagGPS) State.holes[idx].flag = ch.flagGPS;
                        }
                    });
                }
                
                State.courseName = course.name || '';
                State.course = course;
                State.holeIndex = 0;
                State.round = { startedAt: Utils.nowISO() };
                
                State.save();
                UI.render();
                this.close();
                LibraryUI.close();
                Utils.toast('Round started: ' + course.name);
            }
        };

        // ============================================
        // SCORECARD UI
        // ============================================
        
        const ScorecardUI = {

            open() {
                this.render();
                if (UI.els.scorecardBackdrop) UI.els.scorecardBackdrop.classList.add('active');
                if (UI.els.scorecardSheet)    UI.els.scorecardSheet.classList.add('active');
            },

            close() {
                if (UI.els.scorecardBackdrop) UI.els.scorecardBackdrop.classList.remove('active');
                if (UI.els.scorecardSheet)    UI.els.scorecardSheet.classList.remove('active');
            },

            // Returns a <span> with the shot count shown inside the scoring symbol.
            // Shape and color encode score vs par:
            //   Eagle or better â†’ double thin circle, red number
            //   Birdie          â†’ single thin circle, red number
            //   Par             â†’ plain number, white
            //   Bogey           â†’ single thin square, white number
            //   Double bogey    â†’ double thin square, white number
            //   Triple bogey+   â†’ double thin square, white "+N"
            //   Not played      â†’ dash, muted
            // All color/border styling is in CSS â€” JS only assigns the class.
            symbol(shots, par) {
                const el = document.createElement('span');
                el.className = 'sc-sym';

                if (!shots || shots === 0) {
                    el.classList.add('sc-none');
                    el.textContent = '-';
                    return el;
                }

                const diff = shots - par;

                if      (diff <= -2) { el.classList.add('sc-eagle');  el.textContent = String(shots); }
                else if (diff === -1) { el.classList.add('sc-birdie'); el.textContent = String(shots); }
                else if (diff ===  0) { el.classList.add('sc-par');    el.textContent = String(shots); }
                else if (diff ===  1) { el.classList.add('sc-bogey');  el.textContent = String(shots); }
                else if (diff ===  2) { el.classList.add('sc-double'); el.textContent = String(shots); }
                else {
                    // Triple bogey or worse â€” show net over par inside double square
                    el.classList.add('sc-triple');
                    el.textContent = '+' + diff;
                }
                return el;
            },

            // Format cumulative vs-par value: 0="E", over="+N", under="-N"
            relParText(rel) {
                if (rel === 0) return 'E';
                return rel > 0 ? '+' + rel : String(rel);
            },

            // Color for vs-par: under par=red (hot!), over/even=white
            relParColor(rel) {
                if (rel < 0) return 'var(--red)';
                return 'var(--text-primary)';
            },

            // Build one 9-hole table section.
            // Columns: Hole | Yds | Par | Score(symbol) | +/-(cumulative)
            // The +/- column resets to 0 at the start of each section,
            // so Front 9 and Back 9 are read independently.
            // Returns { frag, sectionShots, sectionPar, sectionRel } for the grand total.
            buildSection(startIdx, endIdx, label) {
                const frag = document.createDocumentFragment();

                // Section heading label
                const title = document.createElement('div');
                title.className = 'sc-section-title';
                title.textContent = label;
                frag.appendChild(title);

                const table = document.createElement('table');
                table.className = 'sc-table';

                // Colgroup enforces proportionate column widths via CSS classes
                table.innerHTML = '<colgroup>' +
                    '<col class="sc-col-hole">' +
                    '<col class="sc-col-yds">'  +
                    '<col class="sc-col-par">'  +
                    '<col class="sc-col-score">' +
                    '<col class="sc-col-rel">'  +
                    '</colgroup>' +
                    '<thead><tr>' +
                    '<th class="sc-left">Hole</th>' +
                    '<th>Yds</th>'  +
                    '<th>Par</th>'  +
                    '<th>Score</th>' +
                    '<th>+/-</th>'  +
                    '</tr></thead>';

                const tbody = document.createElement('tbody');

                let sectionShots = 0;  // Total strokes this 9
                let sectionPar   = 0;  // Total par this 9
                let sectionRel   = 0;  // Net vs par this 9
                let cumRel       = 0;  // Running vs-par within this section (resets each 9)

                for (let i = startIdx; i <= endIdx; i++) {
                    const hole  = State.holes[i];
                    const par   = hole.par || 0;
                    const shots = hole.shots ? hole.shots.length : 0;

                    // Accumulate section totals for played holes
                    if (shots > 0) {
                        sectionShots += shots;
                        if (par > 0) {
                            sectionPar += par;
                            sectionRel += (shots - par);
                            cumRel     += (shots - par);  // Update running cumulative
                        }
                    } else if (par > 0) {
                        sectionPar += par;  // Count par even if not played yet
                    }

                    const tr = document.createElement('tr');
                    tr.className = 'sc-row' + (i === State.holeIndex ? ' sc-active' : '');

                    // Hole number (left-aligned)
                    const tdHole = document.createElement('td');
                    tdHole.className = 'sc-left';
                    tdHole.textContent = String(i + 1);

                    // Yards
                    const tdYds = document.createElement('td');
                    tdYds.textContent = hole.yards || '-';

                    // Par
                    const tdPar = document.createElement('td');
                    tdPar.textContent = par || '-';

                    // Score â€” shot count displayed inside the scoring symbol shape
                    const tdScore = document.createElement('td');
                    if (par > 0) {
                        tdScore.appendChild(this.symbol(shots, par));
                    } else {
                        // No par configured â€” show plain number or dash, no symbol border
                        const span = document.createElement('span');
                        span.className = 'sc-sym ' + (shots > 0 ? 'sc-par' : 'sc-none');
                        span.textContent = shots > 0 ? String(shots) : '-';
                        tdScore.appendChild(span);
                    }

                    // Cumulative vs-par for this section (resets at hole 1 and hole 10)
                    const tdRel = document.createElement('td');
                    if (shots > 0 && par > 0) {
                        tdRel.textContent = this.relParText(cumRel);
                        tdRel.style.color = this.relParColor(cumRel);
                    } else {
                        tdRel.textContent = '-';
                        tdRel.style.color = 'var(--text-muted)';
                    }

                    tr.appendChild(tdHole);
                    tr.appendChild(tdYds);
                    tr.appendChild(tdPar);
                    tr.appendChild(tdScore);
                    tr.appendChild(tdRel);
                    tbody.appendChild(tr);
                }

                // Section subtotal row
                const subTr = document.createElement('tr');
                subTr.className = 'sc-subtotal';

                const subLabel = document.createElement('td');
                subLabel.className = 'sc-left';
                subLabel.textContent = label;        // e.g. "Front 9"

                const subYds   = document.createElement('td');
                subYds.textContent = '';             // No yards total

                const subPar   = document.createElement('td');
                subPar.textContent = sectionPar || '-';

                const subShots = document.createElement('td');
                subShots.textContent = sectionShots || '-';

                const subRel = document.createElement('td');
                subRel.textContent = sectionShots > 0 ? this.relParText(sectionRel) : '-';
                subRel.style.color = sectionShots > 0 ? this.relParColor(sectionRel) : '';

                subTr.appendChild(subLabel);
                subTr.appendChild(subYds);
                subTr.appendChild(subPar);
                subTr.appendChild(subShots);
                subTr.appendChild(subRel);
                tbody.appendChild(subTr);

                table.appendChild(tbody);
                frag.appendChild(table);

                return { frag: frag, sectionShots: sectionShots, sectionPar: sectionPar, sectionRel: sectionRel };
            },

            render() {
                const el = UI.els.scorecardContent;
                if (!el) return;
                el.innerHTML = '';

                // Build Front 9 and Back 9 â€” each resets cumulative +/- independently
                const front = this.buildSection(0, 8,  'Front 9');
                const back  = this.buildSection(9, 17, 'Back 9');
                el.appendChild(front.frag);
                el.appendChild(back.frag);

                // Grand total â€” sum of both sections
                const totalShots = front.sectionShots + back.sectionShots;
                const totalPar   = front.sectionPar   + back.sectionPar;
                const totalRel   = front.sectionRel   + back.sectionRel;

                const totalTable = document.createElement('table');
                totalTable.className = 'sc-table';
                totalTable.style.marginTop = 'var(--space-3)';
                totalTable.innerHTML = '<colgroup>' +
                    '<col class="sc-col-hole">'  +
                    '<col class="sc-col-yds">'   +
                    '<col class="sc-col-par">'   +
                    '<col class="sc-col-score">' +
                    '<col class="sc-col-rel">'   +
                    '</colgroup>';

                const totalTbody = document.createElement('tbody');
                const totalTr    = document.createElement('tr');
                totalTr.className = 'sc-total';

                const tLabel = document.createElement('td');
                tLabel.className = 'sc-left';
                tLabel.textContent = 'Total';

                const tYds   = document.createElement('td');
                tYds.textContent = '';

                const tPar   = document.createElement('td');
                tPar.textContent = totalPar || '-';

                const tShots = document.createElement('td');
                tShots.textContent = totalShots || '-';

                const tRel = document.createElement('td');
                tRel.textContent = totalShots > 0 ? this.relParText(totalRel) : '-';
                tRel.style.color = totalShots > 0 ? this.relParColor(totalRel) : '';

                totalTr.appendChild(tLabel);
                totalTr.appendChild(tYds);
                totalTr.appendChild(tPar);
                totalTr.appendChild(tShots);
                totalTr.appendChild(tRel);
                totalTbody.appendChild(totalTr);
                totalTable.appendChild(totalTbody);
                el.appendChild(totalTable);
            }
        };
        const Events = {
            bind() {
                // Tee / Flag / Shot / Mark
                this.on('btnTee', 'click', () => Actions.toggleTee());
                this.on('btnFlag', 'click', () => Actions.toggleFlag());
                this.on('btnShot', 'click', () => Actions.addShot());
                this.on('btnMark', 'click', () => Actions.markLanding());
                
                // Navigation
                this.on('btnPrevHole', 'click', () => Actions.prevHole());
                this.on('btnNextHole', 'click', () => Actions.nextHole());
                this.on('btnHolePick', 'click', () => HolePickerUI.open());
                
                // Actions
                this.on('btnPen', 'click', () => Actions.addPenalty());
                this.on('btnDel', 'click', () => Actions.deleteLastShot());
                this.on('btnFwy', 'click', () => Actions.toggleFwy());
                this.on('btnGir', 'click', () => Actions.toggleGir());
                
                // Caddy
                this.on('btnCaddy', 'click', () => CaddyUI.open());
                this.on('btnCloseCaddy', 'click', () => CaddyUI.close());
                this.on('caddyBackdrop', 'click', () => CaddyUI.close());
                
                this.on('btnCaddyMode', 'click', () => {
                    State.ui.caddyMode = State.ui.caddyMode === 'carry' ? 'total' : 'carry';
                    if (UI.els.btnCaddyMode) {
                        UI.els.btnCaddyMode.textContent = State.ui.caddyMode === 'carry' ? 'Carry' : 'Total';
                    }
                    State.save();
                    CaddyUI.render();
                });
                
                this.on('btnShowAll', 'click', () => {
                    State.ui.showAll = !State.ui.showAll;
                    if (UI.els.btnShowAll) {
                        // Show CURRENT state, not next state
                        // When showAll is TRUE, button says "Show All" (current state)
                        // When showAll is FALSE, button says "Within 10" (current state)
                        UI.els.btnShowAll.textContent = State.ui.showAll ? 'Show All' : 'Within 10';
                    }
                    State.save();
                    CaddyUI.render();
                });
                
                this.on('caddyTarget', 'input', () => CaddyUI.render());
                
                this.on('btnResetTarget', 'click', () => {
                    const toFlag = UI.getToFlagYards();
                    if (UI.els.caddyTarget) {
                        UI.els.caddyTarget.value = toFlag !== null ? String(toFlag) : '';
                    }
                    CaddyUI.render();
                });
                
                // Bag Editor
                this.on('btnBagEditor', 'click', () => {
                    CaddyUI.close();
                    BagEditorUI.open();
                });
                this.on('btnCloseBag', 'click', () => BagEditorUI.close());
                this.on('btnManageClubs', 'click', () => BagEditorUI.openManageClubs());
                this.on('btnCloseManageClubs', 'click', () => BagEditorUI.closeManageClubs());
                this.on('btnAddClub', 'click', () => BagEditorUI.addClub());
                this.on('btnAddShotType', 'click', () => BagEditorUI.addShotType());
                this.on('bagBackdrop', 'click', () => BagEditorUI.close());
                this.on('bagClub', 'change', (e) => {
                    e.stopPropagation();
                    BagEditorUI.loadCurrentSelection();
                });
                this.on('bagShotType', 'change', (e) => {
                    e.stopPropagation();
                    BagEditorUI.loadCurrentSelection();
                });
                this.on('btnSaveBag', 'click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Save button clicked');
                    
                    // Disable button temporarily to prevent double-clicks
                    if (UI.els.btnSaveBag) {
                        if (UI.els.btnSaveBag.disabled) {
                            console.log('Button already disabled, ignoring click');
                            return; // Already processing
                        }
                        
                        console.log('Processing save...');
                        UI.els.btnSaveBag.disabled = true;
                        
                        // Execute save
                        try {
                            BagEditorUI.saveEntry();
                        } catch (err) {
                            console.error('Save error:', err);
                            Utils.toast('Save failed');
                        }
                        
                        // Re-enable after delay
                        setTimeout(() => {
                            if (UI.els.btnSaveBag) {
                                UI.els.btnSaveBag.disabled = false;
                                console.log('Button re-enabled');
                            }
                        }, 500);
                    }
                });
                
                // Course Setup
                this.on('btnSettings', 'click', () => CourseSetupUI.open());
                this.on('btnPickCourse', 'click', () => CourseSetupUI.togglePicker());
                this.on('btnBagHeader', 'click', () => BagEditorUI.open());
                this.on('btnCloseCourse', 'click', () => CourseSetupUI.close());
                this.on('courseBackdrop', 'click', () => CourseSetupUI.close());
                this.on('btnSaveCourse', 'click', () => {
                    CourseSetupUI.saveCourse();
                    CourseSetupUI.close();
                });
                
                // Export
                // Export sheet â€” open on ðŸ“Š icon, two clear choices inside
                this.on('btnExport', 'click', () => {
                    if (UI.els.exportBackdrop) UI.els.exportBackdrop.classList.add('active');
                    if (UI.els.exportSheet)    UI.els.exportSheet.classList.add('active');
                });
                this.on('btnCloseExport', 'click', () => {
                    if (UI.els.exportBackdrop) UI.els.exportBackdrop.classList.remove('active');
                    if (UI.els.exportSheet)    UI.els.exportSheet.classList.remove('active');
                });
                this.on('exportBackdrop', 'click', () => {
                    if (UI.els.exportBackdrop) UI.els.exportBackdrop.classList.remove('active');
                    if (UI.els.exportSheet)    UI.els.exportSheet.classList.remove('active');
                });
                this.on('btnDownloadCSV', 'click', () => {
                    if (UI.els.exportBackdrop) UI.els.exportBackdrop.classList.remove('active');
                    if (UI.els.exportSheet)    UI.els.exportSheet.classList.remove('active');
                    ExportData.downloadCSV();
                });
                this.on('btnViewReport', 'click', () => {
                    if (UI.els.exportBackdrop) UI.els.exportBackdrop.classList.remove('active');
                    if (UI.els.exportSheet)    UI.els.exportSheet.classList.remove('active');
                    ExportData.showReport();
                });
                
                // Hole picker
                this.on('btnCloseHole', 'click', () => HolePickerUI.close());
                this.on('holeBackdrop', 'click', () => HolePickerUI.close());
                
                // Library
                this.on('btnNewRoundHeader', 'click', () => RoundSetupUI.open());
                this.on('btnScorecard', 'click', () => ScorecardUI.open());
                this.on('btnCloseScorecard', 'click', () => ScorecardUI.close());
                this.on('scorecardBackdrop', 'click', () => ScorecardUI.close());
                this.on('btnNewRound', 'click', () => RoundSetupUI.open());
                this.on('btnCancelRound', 'click', () => RoundSetupUI.close());
                this.on('btnStartRound', 'click', () => RoundSetupUI.startRound());
                this.on('btnLibrary', 'click', () => LibraryUI.open());
                this.on('btnCloseLibrary', 'click', () => LibraryUI.close());
                this.on('libraryBackdrop', 'click', () => LibraryUI.close());
                
                // Import / Export
                this.on('btnExportAllBags', 'click', () => ImportExport.exportBags());
                this.on('btnExportAllCourses', 'click', () => ImportExport.exportCourses());
                this.on('btnImportBag', 'click', () => ImportExport.importBags());
                this.on('btnImportCourse', 'click', () => ImportExport.importCourses());
            },
            
            on(elId, event, handler) {
                const el = UI.els[elId];
                if (el) {
                    try {
                        el.addEventListener(event, handler);
                    } catch (e) {
                        console.error(`Event binding error for ${elId}:`, e);
                    }
                }
            }
        };
        
        // ============================================
        // APP INITIALIZATION
        // ============================================
        
        const App = {
            init() {
                try {
                    // Initialize state
                    State.init();
                    
                    // Cache DOM elements
                    UI.cacheElements();
                    
                    // Bind events
                    Events.bind();
                    
                    // Initialize hole picker
                    HolePickerUI.init();
                    
                    // Start GPS
                    GPS.start();
                    
                    // Initial render
                    UI.render();
                    
                    // Expose for GPS callbacks and inline onclick handlers
                    window.App = this;
                    window.LibraryActions = LibraryActions;
                    window.LibraryUI = LibraryUI;
                    
                    console.log('Shot Tracker v39 initialized');
                } catch (e) {
                    console.error('App initialization error:', e);
                    Utils.toast('Error starting app', 3000);
                }
            },
            
            render() {
                UI.render();
            }
        };
        
        // ============================================
        // BOOT
        // ============================================
        
        function boot() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => App.init());
            } else {
                App.init();
            }
        }
        
        boot();
        
    })();
    </script>
</body>
</html>
