<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Logging shot…</title>
</head>
<body style="font-family:system-ui; padding:16px;">
  Logging shot…
<script>
(function(){
  const p = new URLSearchParams(location.search);
  const lat = Number(p.get("lat"));
  const lon = Number(p.get("lon"));
  const ts  = p.get("t") ? Number(p.get("t")) : Date.now();

  const KEY = "shotTrackerRounds_v1";

  function loadIndex(){
    try{ return JSON.parse(localStorage.getItem(KEY) || '{"active":null,"rounds":{}}'); }
    catch{ return {active:null, rounds:{}}; }
  }
  function saveIndex(idx){
    try{ localStorage.setItem(KEY, JSON.stringify(idx)); }catch{}
  }

  function ensureHole(holes, n){
    if(!holes[n]) holes[n] = { holeNumber:n, par:4, fairway:false, gir:false, holeYards:null, teeBox:null, flag:null, shots:[] };
  }

  function distanceYds(aLat,aLon,bLat,bLon){
    const R=6371000;
    const toRad=(d)=>d*Math.PI/180;
    const dLat=toRad(bLat-aLat);
    const dLon=toRad(bLon-aLon);
    const x=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;
    const meters = R * (2*Math.atan2(Math.sqrt(x), Math.sqrt(1-x)));
    return meters * 1.0936133;
  }

  const idx = loadIndex();
  let rid = idx.active;

  // If no active round, create a minimal one so watch logging still works.
  if(!rid){
    rid = "r_watch_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    idx.rounds[rid] = {
      id: rid,
      name: "Watch Round " + new Date().toLocaleString(),
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      state: { currentHole:1, holes:{}, holeSummaries:[], selectedClub:null, selectedShotType:"full", manualValue:null, liveEnabled:true }
    };
    idx.active = rid;
  }

  const round = idx.rounds[rid];
  const state = round.state || {};
  const currentHole = state.currentHole || 1;
  state.holes = state.holes || {};
  ensureHole(state.holes, currentHole);
  const h = state.holes[currentHole];

  const shots = h.shots || (h.shots=[]);

  // Reference point for distance: last non-penalty shot, else tee box.
  let ref = null;
  for(let i=shots.length-1;i>=0;i--){ if(!shots[i].isPenalty){ ref = shots[i]; break; } }
  if(!ref && h.teeBox) ref = { latitude:h.teeBox.latitude, longitude:h.teeBox.longitude };

  const calc = (ref && Number.isFinite(lat) && Number.isFinite(lon))
    ? Math.round(distanceYds(ref.latitude, ref.longitude, lat, lon)*10)/10
    : 0;

  shots.push({
    club: "Club?",
    shotType: "full",
    latitude: lat,
    longitude: lon,
    accuracy: "",
    timestamp: new Date(ts).toISOString(),
    isPenalty: false,
    manualUnit: "",
    manualValue: "",
    distance: calc
  });

  round.state = state;
  round.updatedAt = new Date().toISOString();
  idx.rounds[rid] = round;
  saveIndex(idx);

  location.replace("./index.html");
})();
</script>
</body>
</html>
